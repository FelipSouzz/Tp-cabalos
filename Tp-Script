--[[ 
Script atualizado com Fly (velocidade 3), TP e Busca originais, tema Discord fixo e GUI móvel no celular.
--]]

local Player = game:GetService("Players").LocalPlayer
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local Character
local Humanoid
local connections = {}

-- Velocidade do Fly
local FLY_SPEED = 3
local flying = false
local flyConn

-- Configuração do tema fixo (Discord)
local theme = {
	FrameBG = Color3.fromRGB(54, 57, 63),
	TextPrimary = Color3.fromRGB(255, 255, 255),
	TextSecondary = Color3.fromRGB(180, 180, 180),
	ButtonTP = Color3.fromRGB(88, 101, 242),
	ButtonRefresh = Color3.fromRGB(67, 181, 129),
	ButtonClose = Color3.fromRGB(237, 66, 69),
	ButtonFlyOn = Color3.fromRGB(67, 181, 129),
	ButtonFlyOff = Color3.fromRGB(237, 66, 69),
	WarningBG_Wild = Color3.fromRGB(67, 181, 129),
	WarningBG_Other = Color3.fromRGB(255, 69, 0),
	CornerRadius = UDim.new(0, 8),
	ButtonCorner = UDim.new(0, 6),
	StrokeColor = Color3.fromRGB(40, 42, 46)
}

-- Atualiza Character no spawn
local function setupCharacter(char)
	Character = char
	Humanoid = char:WaitForChild("Humanoid")
end
setupCharacter(Player.Character or Player.CharacterAdded:Wait())
Player.CharacterAdded:Connect(setupCharacter)

-- Função de conexão segura
local function safeConnect(signal, func)
	local conn = signal:Connect(func)
	table.insert(connections, conn)
	return conn
end

-- GUI
local GUI = Instance.new("ScreenGui", Player:WaitForChild("PlayerGui"))
GUI.ResetOnSpawn = false
GUI.Name = "TPFlyGui"

local Frame = Instance.new("Frame", GUI)
Frame.Size = UDim2.new(0, 320, 0, 240)
Frame.Position = UDim2.new(0.5, -160, 0.5, -120)
Frame.AnchorPoint = Vector2.new(0.5, 0.5)
Frame.BackgroundColor3 = theme.FrameBG
Frame.BorderSizePixel = 0

local FrameCorner = Instance.new("UICorner", Frame)
FrameCorner.CornerRadius = theme.CornerRadius

local FrameStroke = Instance.new("UIStroke", Frame)
FrameStroke.Color = theme.StrokeColor

local Title = Instance.new("TextLabel", Frame)
Title.Text = "TP Horse"
Title.Size = UDim2.new(1, -40, 0, 30)
Title.Position = UDim2.new(0, 10, 0, 5)
Title.Font = Enum.Font.SourceSansSemibold
Title.TextSize = 20
Title.TextColor3 = theme.TextPrimary
Title.BackgroundTransparency = 1
Title.TextXAlignment = Enum.TextXAlignment.Left

local Island = Instance.new("TextLabel", Frame)
Island.Text = "Ilha: Buscando..."
Island.Size = UDim2.new(1, -40, 0, 20)
Island.Position = UDim2.new(0, 10, 0, 35)
Island.Font = Enum.Font.SourceSans
Island.TextSize = 14
Island.TextColor3 = theme.TextSecondary
Island.BackgroundTransparency = 1
Island.TextXAlignment = Enum.TextXAlignment.Left

local Status = Instance.new("TextLabel", Frame)
Status.Size = UDim2.new(1, -20, 0.3, 0)
Status.Position = UDim2.new(0, 10, 0.25, 0)
Status.Font = Enum.Font.SourceSans
Status.TextSize = 16
Status.TextColor3 = theme.TextPrimary
Status.BackgroundTransparency = 1
Status.TextWrapped = true
Status.TextYAlignment = Enum.TextYAlignment.Top

local Warning = Instance.new("TextLabel", Frame)
Warning.Size = UDim2.new(1, -20, 0, 30)
Warning.Position = UDim2.new(0, 10, 0.55, 0)
Warning.Font = Enum.Font.SourceSansSemibold
Warning.TextSize = 16
Warning.TextColor3 = Color3.new(1, 1, 1)
Warning.BackgroundColor3 = theme.WarningBG_Other
Warning.Visible = false
local WarningCorner = Instance.new("UICorner", Warning)
WarningCorner.CornerRadius = UDim.new(0, 5)
Warning.Parent = Frame

-- Botões
local function makeButton(text, posX, color)
	local btn = Instance.new("TextButton", Frame)
	btn.Size = UDim2.new(0, 93, 0, 40)
	btn.Position = posX
	btn.Font = Enum.Font.SourceSansSemibold
	btn.TextSize = 18
	btn.AutoButtonColor = false
	btn.Text = text
	btn.TextColor3 = Color3.new(1,1,1)
	btn.BackgroundColor3 = color
	local corner = Instance.new("UICorner", btn)
	corner.CornerRadius = theme.ButtonCorner
	return btn
end

local TP = makeButton("TP", UDim2.new(0,10,0.78,0), theme.ButtonTP)
local Refresh = makeButton("Busca", UDim2.new(0,114,0.78,0), theme.ButtonRefresh)
local FlyBtn = makeButton("Fly", UDim2.new(1,-103,0.78,0), theme.ButtonFlyOff)
local Close = makeButton("X", UDim2.new(1,-35,0,6), theme.ButtonClose)
Close.Size = UDim2.new(0,28,0,28)
Close.TextSize = 18

-- Variáveis de teleporte
local validModels = {}
local currentModelIndex = 1

local function findValidModels()
	local islandsFolder = workspace:FindFirstChild("Islands")
	if not islandsFolder then return {}, "Erro: Islands Missing" end
	for _, h in ipairs(workspace:GetDescendants()) do
		if h:IsA("Highlight") and h.Name == "TeleportHighlight" then h:Destroy() end
	end
	local playerIsland = Character and Character.Parent
	local islandContainer
	while playerIsland and playerIsland ~= islandsFolder do
		if playerIsland.Parent == islandsFolder then
			islandContainer = playerIsland
			break
		end
		playerIsland = playerIsland.Parent
	end
	if not islandContainer then return {}, "Erro: Não na Ilha" end
	local islandName = islandContainer.Name
	local horses = {}
	for _, d in ipairs(islandContainer:GetDescendants()) do
		if d:IsA("Model") and d:FindFirstChildOfClass("Humanoid") and d:FindFirstChild("HumanoidRootPart") and d.Name:match("^%b{}$") then
			local h = Instance.new("Highlight")
			h.Name = "TeleportHighlight"
			h.FillColor = theme.ButtonTP
			h.Adornee = d
			h.Parent = d
			table.insert(horses, {Model=d,RootPart=d.HumanoidRootPart})
		end
	end
	return horses, islandName
end

local function updateGUIStatus()
	if #validModels == 0 then
		Status.Text = "Nenhum cavalo encontrado com nome entre { }"
		Warning.Visible = false
		return
	end
	local info = validModels[currentModelIndex]
	local pos = info.RootPart.Position
	Status.Text = string.format("Cavalo %d de %d:\n%s\nPos: %.1f, %.1f, %.1f",currentModelIndex,#validModels,info.Model.Name,pos.X,pos.Y,pos.Z)
end

local function teleportNext()
	if #validModels == 0 then return end
	currentModelIndex += 1
	if currentModelIndex > #validModels then currentModelIndex = 1 end
	local t = validModels[currentModelIndex]
	if Character then
		Character:PivotTo(CFrame.new(t.RootPart.Position + Vector3.new(0,3,0)))
		updateGUIStatus()
	end
end

local function refreshList()
	validModels, islandName = findValidModels()
	currentModelIndex = 1
	Island.Text = "Ilha: " .. (islandName or "Desconhecida")
	updateGUIStatus()
end

-- Função de Fly
local function toggleFly()
	flying = not flying
	FlyBtn.BackgroundColor3 = flying and theme.ButtonFlyOn or theme.ButtonFlyOff
	if flying then
		if Humanoid then
			Humanoid.PlatformStand = true
		end
		Player.DevEnableMouseLock = true
		local cam = workspace.CurrentCamera
		flyConn = RunService.Heartbeat:Connect(function()
			if not flying or not Character then return end
			local dir = Vector3.new(0,0,0)
			if UIS:IsKeyDown(Enum.KeyCode.W) then dir += cam.CFrame.LookVector end
			if UIS:IsKeyDown(Enum.KeyCode.S) then dir -= cam.CFrame.LookVector end
			if UIS:IsKeyDown(Enum.KeyCode.A) then dir -= cam.CFrame.RightVector end
			if UIS:IsKeyDown(Enum.KeyCode.D) then dir += cam.CFrame.RightVector end
			if UIS:IsKeyDown(Enum.KeyCode.Space) then dir += Vector3.new(0,1,0) end
			if UIS:IsKeyDown(Enum.KeyCode.LeftControl) then dir -= Vector3.new(0,1,0) end
			if dir.Magnitude > 0 then
				Character:TranslateBy(dir.Unit * FLY_SPEED * RunService.Heartbeat:Wait())
			end
		end)
	else
		if flyConn then flyConn:Disconnect() end
		if Humanoid then Humanoid.PlatformStand = false end
	end
end

-- Conectar botões
TP.MouseButton1Click:Connect(teleportNext)
Refresh.MouseButton1Click:Connect(refreshList)
FlyBtn.MouseButton1Click:Connect(toggleFly)
Close.MouseButton1Click:Connect(function()
	for _, c in pairs(connections) do if c.Connected then c:Disconnect() end end
	GUI:Destroy()
end)

-- Arrastar GUI (funciona no PC e celular)
local dragging, dragInput, startPos, startInputPos
Frame.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragging = true
		startInputPos = input.Position
		startPos = Frame.Position
		input.Changed:Connect(function()
			if input.UserInputState == Enum.UserInputState.End then dragging = false end
		end)
	end
end)
UIS.InputChanged:Connect(function(input)
	if dragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
		local delta = input.Position - startInputPos
		Frame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
	end
end)

-- Inicializa
refreshList()
GUI.Enabled = true
