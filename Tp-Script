-- Serviços
local Player = game:GetService("Players").LocalPlayer
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")

-- Variáveis de Character
local Character
local Humanoid
local connections = {}

-- Tema fixo: Discord
local THEMES = {
	Discord = {
		FrameBG = Color3.fromRGB(54, 57, 63),
		TextPrimary = Color3.fromRGB(255, 255, 255),
		TextSecondary = Color3.fromRGB(180, 180, 180),
		ButtonTP = Color3.fromRGB(88, 101, 242),
		ButtonRefresh = Color3.fromRGB(67, 181, 129),
		ButtonClose = Color3.fromRGB(237, 66, 69),
		ButtonFlyOff = Color3.fromRGB(237, 66, 69),
		ButtonFlyOn = Color3.fromRGB(67, 181, 129),
		WarningBG_Wild = Color3.fromRGB(67, 181, 129),
		WarningBG_Other = Color3.fromRGB(255, 69, 0),
		WarningText = Color3.fromRGB(255, 255, 255),
		CornerRadius = UDim.new(0, 8),
		ButtonCorner = UDim.new(0, 6),
		StrokeColor = Color3.fromRGB(40, 42, 46),
		StrokeThickness = 1,
		StrokeTransparency = 0
	}
}
local currentTheme = "Discord"

-- Funções helpers
local function safeConnect(signal, func)
	local conn = signal:Connect(func)
	table.insert(connections, conn)
	return conn
end

local function setupCharacter(char)
	Character = char
	Humanoid = char:WaitForChild("Humanoid")
end
setupCharacter(Player.Character or Player.CharacterAdded:Wait())
safeConnect(Player.CharacterAdded, setupCharacter)

-- GUI
local GUI = Instance.new("ScreenGui")
local Frame = Instance.new("Frame")
local TitleLabel = Instance.new("TextLabel")
local IslandLabel = Instance.new("TextLabel")
local StatusLabel = Instance.new("TextLabel")
local WarningLabel = Instance.new("TextLabel")
local TeleportButton = Instance.new("TextButton")
local RefreshButton = Instance.new("TextButton")
local FlyButton = Instance.new("TextButton")
local CloseButton = Instance.new("TextButton")

-- UICorners
local FrameCorner = Instance.new("UICorner")
local TeleportCorner = Instance.new("UICorner")
local RefreshCorner = Instance.new("UICorner")
local FlyCorner = Instance.new("UICorner")
local CloseCorner = Instance.new("UICorner")
local WarningCorner = Instance.new("UICorner")

-- UIStrokes
local FrameStroke = Instance.new("UIStroke")
local TeleportStroke = Instance.new("UIStroke")
local RefreshStroke = Instance.new("UIStroke")
local FlyStroke = Instance.new("UIStroke")
local CloseStroke = Instance.new("UIStroke")
local WarningStroke = Instance.new("UIStroke")

-- Parents
FrameCorner.Parent = Frame
TeleportCorner.Parent = TeleportButton
RefreshCorner.Parent = RefreshButton
FlyCorner.Parent = FlyButton
CloseCorner.Parent = CloseButton
WarningCorner.Parent = WarningLabel

FrameStroke.Parent = Frame
TeleportStroke.Parent = TeleportButton
RefreshStroke.Parent = RefreshButton
FlyStroke.Parent = FlyButton
CloseStroke.Parent = CloseButton
WarningStroke.Parent = WarningLabel

GUI.Name = "TeleportGUI"
GUI.Parent = Player:WaitForChild("PlayerGui")
GUI.ResetOnSpawn = false

-- Frame base
Frame.Name = "TPFrame"
Frame.Size = UDim2.new(0, 320, 0, 240)
Frame.Position = UDim2.new(0.5, -160, 0.5, -120)
Frame.AnchorPoint = Vector2.new(0.5, 0.5)
Frame.BorderSizePixel = 0
Frame.BackgroundColor3 = THEMES.Discord.FrameBG
Frame.Parent = GUI

-- Labels
TitleLabel.Size = UDim2.new(1, -40, 0, 30)
TitleLabel.Position = UDim2.new(0, 10, 0, 5)
TitleLabel.Text = "TP Horse"
TitleLabel.Font = Enum.Font.SourceSansSemibold
TitleLabel.TextSize = 20
TitleLabel.BackgroundTransparency = 1
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.TextColor3 = THEMES.Discord.TextPrimary
TitleLabel.Parent = Frame

IslandLabel.Name = "IslandLabel"
IslandLabel.Size = UDim2.new(1, -40, 0, 20)
IslandLabel.Position = UDim2.new(0, 10, 0, 35)
IslandLabel.Text = "Ilha: Buscando..."
IslandLabel.Font = Enum.Font.SourceSans
IslandLabel.TextSize = 14
IslandLabel.BackgroundTransparency = 1
IslandLabel.TextXAlignment = Enum.TextXAlignment.Left
IslandLabel.TextColor3 = THEMES.Discord.TextSecondary
IslandLabel.Parent = Frame

StatusLabel.Size = UDim2.new(1, -20, 0.3, 0)
StatusLabel.Position = UDim2.new(0, 10, 0.25, 0)
StatusLabel.Font = Enum.Font.SourceSans
StatusLabel.TextSize = 16
StatusLabel.TextWrapped = true
StatusLabel.TextYAlignment = Enum.TextYAlignment.Top
StatusLabel.BackgroundTransparency = 1
StatusLabel.TextColor3 = THEMES.Discord.TextPrimary
StatusLabel.Parent = Frame

WarningLabel.Name = "WarningLabel"
WarningLabel.Size = UDim2.new(1, -20, 0, 30)
WarningLabel.Position = UDim2.new(0, 10, 0.55, 0)
WarningLabel.Text = "..."
WarningLabel.Font = Enum.Font.SourceSansSemibold
WarningLabel.TextSize = 16
WarningLabel.TextColor3 = THEMES.Discord.WarningText
WarningLabel.BackgroundColor3 = THEMES.Discord.WarningBG_Other
WarningLabel.BorderSizePixel = 0
WarningLabel.Visible = false
WarningLabel.Parent = Frame
WarningCorner.CornerRadius = UDim.new(0, 5)

-- Botões
TeleportButton.Size = UDim2.new(0, 93, 0, 40)
TeleportButton.Position = UDim2.new(0, 10, 0.78, 0)
TeleportButton.Text = "TP"
TeleportButton.Font = Enum.Font.SourceSansSemibold
TeleportButton.TextSize = 18
TeleportButton.AutoButtonColor = false
TeleportButton.BackgroundColor3 = THEMES.Discord.ButtonTP
TeleportButton.TextColor3 = THEMES.Discord.TextPrimary
TeleportButton.Parent = Frame

RefreshButton.Size = UDim2.new(0, 93, 0, 40)
RefreshButton.Position = UDim2.new(0, 114, 0.78, 0)
RefreshButton.Text = "Busca"
RefreshButton.Font = Enum.Font.SourceSansSemibold
RefreshButton.TextSize = 18
RefreshButton.AutoButtonColor = false
RefreshButton.BackgroundColor3 = THEMES.Discord.ButtonRefresh
RefreshButton.TextColor3 = THEMES.Discord.TextPrimary
RefreshButton.Parent = Frame

FlyButton.Size = UDim2.new(0, 93, 0, 40)
FlyButton.Position = UDim2.new(1, -103, 0.78, 0)
FlyButton.Text = "Fly"
FlyButton.Font = Enum.Font.SourceSansSemibold
FlyButton.TextSize = 18
FlyButton.AutoButtonColor = false
FlyButton.BackgroundColor3 = THEMES.Discord.ButtonFlyOff
FlyButton.TextColor3 = THEMES.Discord.TextPrimary
FlyButton.Parent = Frame

CloseButton.Size = UDim2.new(0, 28, 0, 28)
CloseButton.Position = UDim2.new(1, -35, 0, 6)
CloseButton.Text = "X"
CloseButton.Font = Enum.Font.SourceSansBold
CloseButton.TextSize = 18
CloseButton.AutoButtonColor = false
CloseButton.BackgroundColor3 = THEMES.Discord.ButtonClose
CloseButton.TextColor3 = THEMES.Discord.TextPrimary
CloseButton.Parent = Frame

-- Corners
FrameCorner.CornerRadius = THEMES.Discord.CornerRadius
TeleportCorner.CornerRadius = THEMES.Discord.ButtonCorner
RefreshCorner.CornerRadius = THEMES.Discord.ButtonCorner
FlyCorner.CornerRadius = THEMES.Discord.ButtonCorner
CloseCorner.CornerRadius = THEMES.Discord.ButtonCorner

-- Strokes
FrameStroke.Color = THEMES.Discord.StrokeColor
FrameStroke.Thickness = THEMES.Discord.StrokeThickness
FrameStroke.Transparency = THEMES.Discord.StrokeTransparency
TeleportStroke.Color = THEMES.Discord.StrokeColor
TeleportStroke.Thickness = THEMES.Discord.StrokeThickness
TeleportStroke.Transparency = THEMES.Discord.StrokeTransparency
RefreshStroke.Color = THEMES.Discord.StrokeColor
RefreshStroke.Thickness = THEMES.Discord.StrokeThickness
RefreshStroke.Transparency = THEMES.Discord.StrokeTransparency
FlyStroke.Color = THEMES.Discord.StrokeColor
FlyStroke.Thickness = THEMES.Discord.StrokeThickness
FlyStroke.Transparency = THEMES.Discord.StrokeTransparency
CloseStroke.Color = THEMES.Discord.StrokeColor
CloseStroke.Thickness = THEMES.Discord.StrokeThickness
CloseStroke.Transparency = THEMES.Discord.StrokeTransparency
WarningStroke.Color = THEMES.Discord.StrokeColor
WarningStroke.Thickness = THEMES.Discord.StrokeThickness
WarningStroke.Transparency = THEMES.Discord.StrokeTransparency

-- ======================
-- FUNÇÕES DE TELEPORT/REFRESH
-- ======================
local validModels = {}
local currentModelIndex = 1

local function findValidModels()
	local islandsFolder = Workspace:FindFirstChild("Islands")
	if not islandsFolder then return {}, "Erro: Islands Missing" end

	-- Remove highlights antigos
	for _, obj in ipairs(Workspace:GetDescendants()) do
		if obj:IsA("Highlight") and obj.Name == "TeleportHighlight" then
			obj:Destroy()
		end
	end

	-- Descobre ilha do jogador
	local playerIslandFolder = Character and Character.Parent
	local islandContainer = nil
	while playerIslandFolder and playerIslandFolder ~= islandsFolder and playerIslandFolder ~= Workspace do
		if playerIslandFolder.Parent == islandsFolder then
			islandContainer = playerIslandFolder
			break
		end
		playerIslandFolder = playerIslandFolder.Parent
	end
	if not islandContainer then return {}, "Erro: Não na Ilha" end

	local islandName = islandContainer.Name
	local wildHorses = {}
	local otherHorses = {}

	local theme = THEMES[currentTheme]

	for _, descendant in ipairs(islandContainer:GetDescendants()) do
		if descendant:IsA("Model")
		and descendant:FindFirstChildOfClass("Humanoid")
		and descendant:FindFirstChild("HumanoidRootPart")
		and descendant.Name:match("^%b{}$") then

			local rootPart = descendant.HumanoidRootPart
			local hasCaptureProgress = false
			for _, e in ipairs(descendant:GetDescendants()) do
				if e.Name == "CaptureProgress" then hasCaptureProgress = true break end
			end

			local highlight = Instance.new("Highlight")
			highlight.Name = "TeleportHighlight"
			highlight.FillColor = hasCaptureProgress and theme.WarningBG_Wild or theme.ButtonTP
			highlight.OutlineColor = Color3.fromRGB(255,255,255)
			highlight.FillTransparency = 0.5
			highlight.OutlineTransparency = 0
			highlight.Adornee = descendant
			highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
			highlight.Parent = descendant

			local horseData = { Model = descendant, RootPart = rootPart, IsWild = hasCaptureProgress }
			if hasCaptureProgress then table.insert(wildHorses, horseData)
			else table.insert(otherHorses, horseData) end
		end
	end

	table.sort(wildHorses, function(a,b) return a.Model.Name<b.Model.Name end)
	table.sort(otherHorses, function(a,b) return a.Model.Name<b.Model.Name end)
	local allHorses = {}
	for _,h in ipairs(wildHorses) do table.insert(allHorses,h) end
	for _,h in ipairs(otherHorses) do table.insert(allHorses,h) end

	return allHorses, islandName
end

local function checkCurrentModelStatus()
	if GUI.Enabled == false or #validModels == 0 or currentModelIndex > #validModels then
		WarningLabel.Visible = false
		return
	end
	local theme = THEMES[currentTheme]
	local modelInfo = validModels[currentModelIndex]
	local currentModel = modelInfo.Model
	local isWildNow = false
	for _, e in ipairs(currentModel:GetDescendants()) do
		if e.Name=="CaptureProgress" then isWildNow=true break
