-- Teleport + Fly integrados por FELIPE (com limites no botão 0 e sem X do Fly)
local Players = game:GetService("Players")
local Player = Players.LocalPlayer
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local Character
local Humanoid
local connections = {}

local THEMES = {
	Discord = {
		FrameBG = Color3.fromRGB(54, 57, 63),
		TextPrimary = Color3.fromRGB(255, 255, 255),
		TextSecondary = Color3.fromRGB(180, 180, 180),
		ButtonTP = Color3.fromRGB(88, 101, 242),
		ButtonRefresh = Color3.fromRGB(67, 181, 129),
		ButtonClose = Color3.fromRGB(237, 66, 69),
		WarningBG_Wild = Color3.fromRGB(67, 181, 129),
		WarningBG_Other = Color3.fromRGB(255, 69, 0),
		WarningText = Color3.fromRGB(255, 255, 255),
		CornerRadius = UDim.new(0, 8),
		ButtonCorner = UDim.new(0, 6),
		StrokeColor = Color3.fromRGB(40, 42, 46),
		StrokeThickness = 1,
		StrokeTransparency = 0
	}
}

local function safeConnect(signal, func)
	local conn = signal:Connect(func)
	table.insert(connections, conn)
	return conn
end

local function setupCharacter(char)
	Character = char
	Humanoid = char:WaitForChild("Humanoid")
end

setupCharacter(Player.Character or Player.CharacterAdded:Wait())
safeConnect(Player.CharacterAdded, setupCharacter)

-- ============================
-- === GUI Teleport (TP) ====
-- ============================
local GUI = Instance.new("ScreenGui")
local Frame = Instance.new("Frame")
local TitleLabel = Instance.new("TextLabel")
local IslandLabel = Instance.new("TextLabel")
local StatusLabel = Instance.new("TextLabel")
local WarningLabel = Instance.new("TextLabel")
local TeleportButton = Instance.new("TextButton")
local RefreshButton = Instance.new("TextButton")
local CloseButton = Instance.new("TextButton")
local MinimizeButton = Instance.new("TextButton") -- botão cinza para minimizar
-- Botão 0 (restaurar) usado para restaurar GUIs minimizadas
local RestoreButton0 = Instance.new("TextButton")

local FrameCorner = Instance.new("UICorner")
local TeleportCorner = Instance.new("UICorner")
local RefreshCorner = Instance.new("UICorner")
local CloseCorner = Instance.new("UICorner")
local MinimizeCorner = Instance.new("UICorner")
local WarningCorner = Instance.new("UICorner")
local RestoreCorner = Instance.new("UICorner")

local FrameStroke = Instance.new("UIStroke")
local TeleportStroke = Instance.new("UIStroke")
local RefreshStroke = Instance.new("UIStroke")
local CloseStroke = Instance.new("UIStroke")
local MinimizeStroke = Instance.new("UIStroke")
local WarningStroke = Instance.new("UIStroke")
local RestoreStroke = Instance.new("UIStroke")

FrameCorner.Parent = Frame
TeleportCorner.Parent = TeleportButton
RefreshCorner.Parent = RefreshButton
CloseCorner.Parent = CloseButton
MinimizeCorner.Parent = MinimizeButton
WarningCorner.Parent = WarningLabel
RestoreCorner.Parent = RestoreButton0

FrameStroke.Parent = Frame
TeleportStroke.Parent = TeleportButton
RefreshStroke.Parent = RefreshButton
CloseStroke.Parent = CloseButton
MinimizeStroke.Parent = MinimizeButton
WarningStroke.Parent = WarningLabel
RestoreStroke.Parent = RestoreButton0

GUI.Name = "TeleportGUI"
GUI.Parent = Player:WaitForChild("PlayerGui")
GUI.ResetOnSpawn = false

Frame.Name = "TPFrame"
Frame.Size = UDim2.new(0, 320, 0, 240)
Frame.Position = UDim2.new(0.5, -160, 0.5, -120)
Frame.AnchorPoint = Vector2.new(0.5, 0.5)
Frame.BorderSizePixel = 0
Frame.Parent = GUI

TitleLabel.Size = UDim2.new(1, -40, 0, 30)
TitleLabel.Position = UDim2.new(0, 10, 0, 5)
TitleLabel.Text = "TP-Horses by FELIPE"
TitleLabel.Font = Enum.Font.SourceSansSemibold
TitleLabel.TextSize = 20
TitleLabel.BackgroundTransparency = 1
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.Parent = Frame

IslandLabel.Name = "IslandLabel"
IslandLabel.Size = UDim2.new(1, -40, 0, 20)
IslandLabel.Position = UDim2.new(0, 10, 0, 35)
IslandLabel.Text = "Ilha: Buscando..."
IslandLabel.Font = Enum.Font.SourceSans
IslandLabel.TextSize = 14
IslandLabel.BackgroundTransparency = 1
IslandLabel.TextXAlignment = Enum.TextXAlignment.Left
IslandLabel.Parent = Frame

CloseButton.Size = UDim2.new(0, 28, 0, 28)
CloseButton.Position = UDim2.new(1, -35, 0, 6)
CloseButton.Text = "X"
CloseButton.Font = Enum.Font.SourceSansBold
CloseButton.TextSize = 18
CloseButton.AutoButtonColor = false
CloseButton.Parent = Frame

-- botão minimizar (cinza) ao lado esquerdo do Close
MinimizeButton.Name = "MinimizeButton"
MinimizeButton.Size = UDim2.new(0, 28, 0, 28)
MinimizeButton.Position = UDim2.new(1, -70, 0, 6) -- ao lado do X
MinimizeButton.Text = "-"
MinimizeButton.Font = Enum.Font.SourceSansBold
MinimizeButton.TextSize = 18
MinimizeButton.AutoButtonColor = false
MinimizeButton.Parent = Frame

StatusLabel.Size = UDim2.new(1, -20, 0.3, 0)
StatusLabel.Position = UDim2.new(0, 10, 0.25, 0)
StatusLabel.Font = Enum.Font.SourceSans
StatusLabel.TextSize = 16
StatusLabel.TextWrapped = true
StatusLabel.TextYAlignment = Enum.TextYAlignment.Top
StatusLabel.BackgroundTransparency = 1
StatusLabel.Parent = Frame

WarningLabel.Name = "WarningLabel"
WarningLabel.Size = UDim2.new(1, -20, 0, 30)
WarningLabel.Position = UDim2.new(0, 10, 0.55, 0)
WarningLabel.Text = "..."
WarningLabel.Font = Enum.Font.SourceSansSemibold
WarningLabel.TextSize = 16
WarningLabel.TextColor3 = THEMES.Discord.WarningText
WarningLabel.BackgroundColor3 = THEMES.Discord.WarningBG_Other
WarningLabel.BorderSizePixel = 0
WarningLabel.Visible = false
WarningLabel.Parent = Frame
WarningCorner.CornerRadius = UDim.new(0, 5)

TeleportButton.Size = UDim2.new(0, 93, 0, 40)
TeleportButton.Text = "TP"
TeleportButton.Font = Enum.Font.SourceSansSemibold
TeleportButton.TextSize = 18
TeleportButton.AutoButtonColor = false
TeleportButton.Parent = Frame

RefreshButton.Size = UDim2.new(0, 93, 0, 40)
RefreshButton.Text = "Busca"
RefreshButton.Font = Enum.Font.SourceSansSemibold
RefreshButton.TextSize = 18
RefreshButton.AutoButtonColor = false
RefreshButton.Parent = Frame

-- Botão 0 (restaurar) com imagem
RestoreButton0.Name = "RestoreButton0"
RestoreButton0.Size = UDim2.new(0, 48, 0, 48)
RestoreButton0.Position = UDim2.new(0.5, -24, 0.5, -24)
RestoreButton0.AnchorPoint = Vector2.new(0.5, 0.5)
RestoreButton0.Text = "" -- remove o texto
RestoreButton0.AutoButtonColor = true -- permite hover efeito
RestoreButton0.BackgroundColor3 = Color3.fromRGB(255, 255, 255) -- cor de fundo neutra para melhor contraste
RestoreButton0.Parent = GUI
RestoreButton0.Visible = false

-- Adiciona imagem ao botão
local RestoreImage = Instance.new("ImageLabel")
RestoreImage.Name = "RestoreImage"
RestoreImage.Parent = RestoreButton0
RestoreImage.Size = UDim2.new(1, 0, 1, 0)
RestoreImage.Position = UDim2.new(0, 0, 0, 0)
RestoreImage.BackgroundTransparency = 1
RestoreImage.Image = "rbxassetid://17435879065" -- ID da imagem
RestoreImage.ScaleType = Enum.ScaleType.Fit -- mantém proporção da imagem
RestoreImage.ZIndex = RestoreButton0.ZIndex + 1 -- garante que fique acima do botão

local function centerButtons()
	local spacing = 14
	local tpWidth = TeleportButton.Size.X.Offset
	local rfWidth = RefreshButton.Size.X.Offset
	local totalWidth = tpWidth + rfWidth + spacing
	local startX = -totalWidth / 2
	TeleportButton.Position = UDim2.new(0.5, startX, 0.78, 0)
	RefreshButton.Position = UDim2.new(0.5, startX + tpWidth + spacing, 0.78, 0)
end

local function applyTheme()
	local theme = THEMES.Discord
	Frame.BackgroundColor3 = theme.FrameBG
	FrameCorner.CornerRadius = theme.CornerRadius
	FrameStroke.Color = theme.StrokeColor
	FrameStroke.Thickness = theme.StrokeThickness
	FrameStroke.Transparency = theme.StrokeTransparency
	TitleLabel.TextColor3 = theme.TextPrimary
	StatusLabel.TextColor3 = theme.TextPrimary
	IslandLabel.TextColor3 = theme.TextSecondary
	WarningLabel.TextColor3 = theme.WarningText
	WarningStroke.Color = theme.StrokeColor
	WarningStroke.Thickness = theme.StrokeThickness
	WarningStroke.Transparency = theme.StrokeTransparency
	TeleportButton.BackgroundColor3 = theme.ButtonTP
	RefreshButton.BackgroundColor3 = theme.ButtonRefresh
	CloseButton.BackgroundColor3 = theme.ButtonClose
	MinimizeButton.BackgroundColor3 = Color3.fromRGB(140, 140, 140) -- cinza
	RestoreButton0.BackgroundColor3 = Color3.fromRGB(10, 10, 10) -- preto escuro
	TeleportButton.TextColor3 = theme.TextPrimary
	RefreshButton.TextColor3 = theme.TextPrimary
	CloseButton.TextColor3 = theme.TextPrimary
	MinimizeButton.TextColor3 = Color3.fromRGB(255,255,255)
	RestoreButton0.TextColor3 = Color3.fromRGB(255,255,255)
	local bCorner = theme.ButtonCorner
	TeleportCorner.CornerRadius = bCorner
	RefreshCorner.CornerRadius = bCorner
	CloseCorner.CornerRadius = bCorner
	MinimizeCorner.CornerRadius = bCorner
	RestoreCorner.CornerRadius = UDim.new(0, 12)
	local bStrokeColor = theme.StrokeColor
	local bStrokeThickness = theme.StrokeThickness
	local bStrokeTransparency = theme.StrokeTransparency
	TeleportStroke.Color = bStrokeColor
	TeleportStroke.Thickness = bStrokeThickness
	TeleportStroke.Transparency = bStrokeTransparency
	RefreshStroke.Color = bStrokeColor
	RefreshStroke.Thickness = bStrokeThickness
	RefreshStroke.Transparency = bStrokeTransparency
	CloseStroke.Color = bStrokeColor
	CloseStroke.Thickness = bStrokeThickness
	CloseStroke.Transparency = bStrokeTransparency
	MinimizeStroke.Color = bStrokeColor
	MinimizeStroke.Thickness = bStrokeThickness
	MinimizeStroke.Transparency = bStrokeTransparency
	RestoreStroke.Color = bStrokeColor
	RestoreStroke.Thickness = bStrokeThickness
	RestoreStroke.Transparency = bStrokeTransparency

	centerButtons()
end

-- ============================
-- === Fly GUI & Lógica ====
-- ============================
-- renomeado para evitar conflitos
local flyMain = Instance.new("ScreenGui")
local flyFrame = Instance.new("Frame")
local flyUp = Instance.new("TextButton")
local flyDown = Instance.new("TextButton")
local flyOnOff = Instance.new("TextButton")
local flyLabel = Instance.new("TextLabel")
local flyPlus = Instance.new("TextButton")
local flySpeedLabel = Instance.new("TextLabel")
local flyMinus = Instance.new("TextButton")
-- removed flyClose (X) per request
local flyMini = Instance.new("TextButton")
local flyMini2 = Instance.new("TextButton")

flyMain.Name = "FlyMain"
flyMain.Parent = Player:WaitForChild("PlayerGui")
flyMain.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
flyMain.ResetOnSpawn = false

flyFrame.Parent = flyMain
flyFrame.BackgroundColor3 = Color3.fromRGB(163, 255, 137)
flyFrame.BorderColor3 = Color3.fromRGB(103, 221, 213)
flyFrame.Position = UDim2.new(0.100320168, 0, 0.379746825, 0)
flyFrame.Size = UDim2.new(0, 190, 0, 57)

flyUp.Name = "up"
flyUp.Parent = flyFrame
flyUp.BackgroundColor3 = Color3.fromRGB(79, 255, 152)
flyUp.Size = UDim2.new(0, 44, 0, 28)
flyUp.Font = Enum.Font.SourceSans
flyUp.Text = "UP"
flyUp.TextColor3 = Color3.fromRGB(0, 0, 0)
flyUp.TextSize = 14.000

flyDown.Name = "down"
flyDown.Parent = flyFrame
flyDown.BackgroundColor3 = Color3.fromRGB(215, 255, 121)
flyDown.Position = UDim2.new(0, 0, 0.491228074, 0)
flyDown.Size = UDim2.new(0, 44, 0, 28)
flyDown.Font = Enum.Font.SourceSans
flyDown.Text = "DOWN"
flyDown.TextColor3 = Color3.fromRGB(0, 0, 0)
flyDown.TextSize = 14.000

flyOnOff.Name = "onof"
flyOnOff.Parent = flyFrame
flyOnOff.BackgroundColor3 = Color3.fromRGB(255, 249, 74)
flyOnOff.Position = UDim2.new(0.702823281, 0, 0.491228074, 0)
flyOnOff.Size = UDim2.new(0, 56, 0, 28)
flyOnOff.Font = Enum.Font.SourceSans
flyOnOff.Text = "fly"
flyOnOff.TextColor3 = Color3.fromRGB(0, 0, 0)
flyOnOff.TextSize = 14.000

flyLabel.Parent = flyFrame
flyLabel.BackgroundColor3 = Color3.fromRGB(242, 60, 255)
flyLabel.Position = UDim2.new(0.469327301, 0, 0, 0)
flyLabel.Size = UDim2.new(0, 100, 0, 28)
flyLabel.Font = Enum.Font.SourceSans
flyLabel.Text = "FLY GUI V3"
flyLabel.TextColor3 = Color3.fromRGB(0, 0, 0)
flyLabel.TextScaled = true
flyLabel.TextSize = 14.000
flyLabel.TextWrapped = true

flyPlus.Name = "plus"
flyPlus.Parent = flyFrame
flyPlus.BackgroundColor3 = Color3.fromRGB(133, 145, 255)
flyPlus.Position = UDim2.new(0.231578946, 0, 0, 0)
flyPlus.Size = UDim2.new(0, 45, 0, 28)
flyPlus.Font = Enum.Font.SourceSans
flyPlus.Text = "+"
flyPlus.TextColor3 = Color3.fromRGB(0, 0, 0)
flyPlus.TextScaled = true
flyPlus.TextSize = 14.000
flyPlus.TextWrapped = true

flySpeedLabel.Name = "speed"
flySpeedLabel.Parent = flyFrame
flySpeedLabel.BackgroundColor3 = Color3.fromRGB(255, 85, 0)
flySpeedLabel.Position = UDim2.new(0.468421042, 0, 0.491228074, 0)
flySpeedLabel.Size = UDim2.new(0, 44, 0, 28)
flySpeedLabel.Font = Enum.Font.SourceSans
flySpeedLabel.Text = "1"
flySpeedLabel.TextColor3 = Color3.fromRGB(0, 0, 0)
flySpeedLabel.TextScaled = true
flySpeedLabel.TextSize = 14.000
flySpeedLabel.TextWrapped = true

flyMinus.Name = "mine"
flyMinus.Parent = flyFrame
flyMinus.BackgroundColor3 = Color3.fromRGB(123, 255, 247)
flyMinus.Position = UDim2.new(0.231578946, 0, 0.491228074, 0)
flyMinus.Size = UDim2.new(0, 45, 0, 29)
flyMinus.Font = Enum.Font.SourceSans
flyMinus.Text = "-"
flyMinus.TextColor3 = Color3.fromRGB(0, 0, 0)
flyMinus.TextScaled = true
flyMinus.TextSize = 14.000
flyMinus.TextWrapped = true

-- removed flyClose UI element (X) as requested

flyMini.Name = "minimize"
flyMini.Parent = flyFrame
flyMini.BackgroundColor3 = Color3.fromRGB(192, 150, 230)
flyMini.Font = "SourceSans"
flyMini.Size = UDim2.new(0, 45, 0, 28)
flyMini.Text = "-"
flyMini.TextSize = 40
flyMini.Position = UDim2.new(0, 44, -1, 27)

flyMini2.Name = "minimize2"
flyMini2.Parent = flyFrame
flyMini2.BackgroundColor3 = Color3.fromRGB(192, 150, 230)
flyMini2.Font = "SourceSans"
flyMini2.Size = UDim2.new(0, 45, 0, 28)
flyMini2.Text = "+"
flyMini2.TextSize = 40
flyMini2.Position = UDim2.new(0, 44, -1, 57)
flyMini2.Visible = false

-- default fly vars
local fly_speeds = 1
local speaker = Players.LocalPlayer
local nowe = false
local tpwalking = false

-- notify
pcall(function()
	game:GetService("StarterGui"):SetCore("SendNotification", {
		Title = "FLY GUI V3";
		Text = "BY XNEO";
		Icon = "rbxthumb://type=Asset&id=5107182114&w=150&h=150"
	})
end)

flyFrame.Active = true
flyFrame.Draggable = true

-- Fly on/off logic (preserved from seu script, adaptado para variáveis renomeadas)
flyOnOff.MouseButton1Down:Connect(function()
	if nowe == true then
		nowe = false
		local charHum = speaker.Character and speaker.Character:FindFirstChildOfClass("Humanoid")
		if charHum then
			charHum:SetStateEnabled(Enum.HumanoidStateType.Climbing,true)
			charHum:SetStateEnabled(Enum.HumanoidStateType.FallingDown,true)
			charHum:SetStateEnabled(Enum.HumanoidStateType.Flying,true)
			charHum:SetStateEnabled(Enum.HumanoidStateType.Freefall,true)
			charHum:SetStateEnabled(Enum.HumanoidStateType.GettingUp,true)
			charHum:SetStateEnabled(Enum.HumanoidStateType.Jumping,true)
			charHum:SetStateEnabled(Enum.HumanoidStateType.Landed,true)
			charHum:SetStateEnabled(Enum.HumanoidStateType.Physics,true)
			charHum:SetStateEnabled(Enum.HumanoidStateType.PlatformStanding,true)
			charHum:SetStateEnabled(Enum.HumanoidStateType.Ragdoll,true)
			charHum:SetStateEnabled(Enum.HumanoidStateType.Running,true)
			charHum:SetStateEnabled(Enum.HumanoidStateType.RunningNoPhysics,true)
			charHum:SetStateEnabled(Enum.HumanoidStateType.Seated,true)
			charHum:SetStateEnabled(Enum.HumanoidStateType.StrafingNoPhysics,true)
			charHum:SetStateEnabled(Enum.HumanoidStateType.Swimming,true)
			charHum:ChangeState(Enum.HumanoidStateType.RunningNoPhysics)
		end
	else
		nowe = true
		-- cria os tpwalking threads conforme speeds
		for i = 1, fly_speeds do
			spawn(function()
				local hb = RunService.Heartbeat
				tpwalking = true
				local chr = Players.LocalPlayer.Character
				local hum = chr and chr:FindFirstChildWhichIsA("Humanoid")
				while tpwalking and hb:Wait() and chr and hum and hum.Parent do
					if hum.MoveDirection.Magnitude > 0 then
						chr:TranslateBy(hum.MoveDirection)
					end
				end
			end)
		end
		-- desativa animações para dar "fly"
		local Char = Players.LocalPlayer.Character
		if Char then
			local Hum = Char:FindFirstChildOfClass("Humanoid") or Char:FindFirstChildOfClass("AnimationController")
			if Hum then
				for _,v in next, Hum:GetPlayingAnimationTracks() do
					v:AdjustSpeed(0)
				end
			end
		end
		local charHum = speaker.Character and speaker.Character:FindFirstChildOfClass("Humanoid")
		if charHum then
			charHum:SetStateEnabled(Enum.HumanoidStateType.Climbing,false)
			charHum:SetStateEnabled(Enum.HumanoidStateType.FallingDown,false)
			charHum:SetStateEnabled(Enum.HumanoidStateType.Flying,false)
			charHum:SetStateEnabled(Enum.HumanoidStateType.Freefall,false)
			charHum:SetStateEnabled(Enum.HumanoidStateType.GettingUp,false)
			charHum:SetStateEnabled(Enum.HumanoidStateType.Jumping,false)
			charHum:SetStateEnabled(Enum.HumanoidStateType.Landed,false)
			charHum:SetStateEnabled(Enum.HumanoidStateType.Physics,false)
			charHum:SetStateEnabled(Enum.HumanoidStateType.PlatformStanding,false)
			charHum:SetStateEnabled(Enum.HumanoidStateType.Ragdoll,false)
			charHum:SetStateEnabled(Enum.HumanoidStateType.Running,false)
			charHum:SetStateEnabled(Enum.HumanoidStateType.RunningNoPhysics,false)
			charHum:SetStateEnabled(Enum.HumanoidStateType.Seated,false)
			charHum:SetStateEnabled(Enum.HumanoidStateType.StrafingNoPhysics,false)
			charHum:SetStateEnabled(Enum.HumanoidStateType.Swimming,false)
			charHum:ChangeState(Enum.HumanoidStateType.Swimming)
		end
	end

	-- Flight loop: R6 / R15 behavior roughly preserved
	spawn(function()
		local chr = Players.LocalPlayer.Character
		if not chr then return end
		if chr:FindFirstChildOfClass("Humanoid").RigType == Enum.HumanoidRigType.R6 then
			local plr = Players.LocalPlayer
			local torso = plr.Character and plr.Character:FindFirstChild("Torso")
			if not torso then return end
			local bg = Instance.new("BodyGyro", torso)
			bg.P = 9e4
			bg.maxTorque = Vector3.new(9e9, 9e9, 9e9)
			bg.cframe = torso.CFrame
			local bv = Instance.new("BodyVelocity", torso)
			bv.velocity = Vector3.new(0,0.1,0)
			bv.maxForce = Vector3.new(9e9, 9e9, 9e9)
			if nowe == true and plr.Character and plr.Character:FindFirstChildOfClass("Humanoid") then
				plr.Character.Humanoid.PlatformStand = true
			end
			local ctrl = {f = 0, b = 0, l = 0, r = 0}
			local lastctrl = {f = 0, b = 0, l = 0, r = 0}
			local maxspeed = 50
			local speed = 0
			while nowe == true and plr.Character and plr.Character:FindFirstChildOfClass("Humanoid") and plr.Character:FindFirstChildOfClass("Humanoid").Health > 0 do
				RunService.RenderStepped:Wait()
				-- not hooking keyboard here (same as original)
				if ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0 then
					speed = speed + .5 + (speed/maxspeed)
					if speed > maxspeed then speed = maxspeed end
				elseif not (ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0) and speed ~= 0 then
					speed = speed - 1
					if speed < 0 then speed = 0 end
				end
				-- movement calculation preserved
				if (ctrl.l + ctrl.r) ~= 0 or (ctrl.f + ctrl.b) ~= 0 then
					bv.velocity = ((workspace.CurrentCamera.CoordinateFrame.lookVector * (ctrl.f+ctrl.b)) + ((workspace.CurrentCamera.CoordinateFrame * CFrame.new(ctrl.l+ctrl.r,(ctrl.f+ctrl.b)*.2,0).p) - workspace.CurrentCamera.CoordinateFrame.p))*speed
					lastctrl = {f = ctrl.f, b = ctrl.b, l = ctrl.l, r = ctrl.r}
				elseif (ctrl.l + ctrl.r) == 0 and (ctrl.f + ctrl.b) == 0 and speed ~= 0 then
					bv.velocity = ((workspace.CurrentCamera.CoordinateFrame.lookVector * (lastctrl.f+lastctrl.b)) + ((workspace.CurrentCamera.CoordinateFrame * CFrame.new(lastctrl.l+lastctrl.r,(lastctrl.f+lastctrl.b)*.2,0).p) - workspace.CurrentCamera.CoordinateFrame.p))*speed
				else
					bv.velocity = Vector3.new(0,0,0)
				end
				bg.cframe = workspace.CurrentCamera.CoordinateFrame * CFrame.Angles(-math.rad((ctrl.f+ctrl.b)*50*speed/maxspeed),0,0)
			end
			-- cleanup
			pcall(function() bg:Destroy() bv:Destroy() if plr.Character and plr.Character:FindFirstChildOfClass("Humanoid") then plr.Character.Humanoid.PlatformStand = false end end)
		else
			local plr = Players.LocalPlayer
			local UpperTorso = plr.Character and plr.Character:FindFirstChild("UpperTorso")
			if not UpperTorso then return end
			local bg = Instance.new("BodyGyro", UpperTorso)
			bg.P = 9e4
			bg.maxTorque = Vector3.new(9e9, 9e9, 9e9)
			bg.cframe = UpperTorso.CFrame
			local bv = Instance.new("BodyVelocity", UpperTorso)
			bv.velocity = Vector3.new(0,0.1,0)
			bv.maxForce = Vector3.new(9e9, 9e9, 9e9)
			if nowe == true and plr.Character and plr.Character:FindFirstChildOfClass("Humanoid") then
				plr.Character.Humanoid.PlatformStand = true
			end
			local ctrl = {f = 0, b = 0, l = 0, r = 0}
			local lastctrl = {f = 0, b = 0, l = 0, r = 0}
			local maxspeed = 50
			local speed = 0
			while nowe == true and plr.Character and plr.Character:FindFirstChildOfClass("Humanoid") and plr.Character:FindFirstChildOfClass("Humanoid").Health > 0 do
				wait()
				if ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0 then
					speed = speed + .5 + (speed/maxspeed)
					if speed > maxspeed then speed = maxspeed end
				elseif not (ctrl.l + ctrl.r ~= 0 or ctrl.f + ctrl.b ~= 0) and speed ~= 0 then
					speed = speed - 1
					if speed < 0 then speed = 0 end
				end
				if (ctrl.l + ctrl.r) ~= 0 or (ctrl.f + ctrl.b) ~= 0 then
					bv.velocity = ((workspace.CurrentCamera.CoordinateFrame.lookVector * (ctrl.f+ctrl.b)) + ((workspace.CurrentCamera.CoordinateFrame * CFrame.new(ctrl.l+ctrl.r,(ctrl.f+ctrl.b)*.2,0).p) - workspace.CurrentCamera.CoordinateFrame.p))*speed
					lastctrl = {f = ctrl.f, b = ctrl.b, l = ctrl.l, r = ctrl.r}
				elseif (ctrl.l + ctrl.r) == 0 and (ctrl.f + ctrl.b) == 0 and speed ~= 0 then
					bv.velocity = ((workspace.CurrentCamera.CoordinateFrame.lookVector * (lastctrl.f+lastctrl.b)) + ((workspace.CurrentCamera.CoordinateFrame * CFrame.new(lastctrl.l+lastctrl.r,(lastctrl.f+lastctrl.b)*.2,0).p) - workspace.CurrentCamera.CoordinateFrame.p))*speed
				else
					bv.velocity = Vector3.new(0,0,0)
				end

				bg.cframe = workspace.CurrentCamera.CoordinateFrame * CFrame.Angles(-math.rad((ctrl.f+ctrl.b)*50*speed/maxspeed),0,0)
			end
			pcall(function() bg:Destroy() bv:Destroy() if plr.Character and plr.Character:FindFirstChildOfClass("Humanoid") then plr.Character.Humanoid.PlatformStand = false end end)
		end
		-- restore flags
		tpwalking = false
	end)
end)

-- up/down behaviour (move HumanoidRootPart while pressed)
do
	local tis
	flyUp.MouseButton1Down:Connect(function()
		tis = flyUp.MouseEnter:Connect(function()
			while tis do
				wait()
				local hrp = Players.LocalPlayer.Character and Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
				if hrp then hrp.CFrame = hrp.CFrame * CFrame.new(0,1,0) end
			end
		end)
	end)
	flyUp.MouseLeave:Connect(function()
		if tis then tis:Disconnect(); tis = nil end
	end)
end

do
	local dis
	flyDown.MouseButton1Down:Connect(function()
		dis = flyDown.MouseEnter:Connect(function()
			while dis do
				wait()
				local hrp = Players.LocalPlayer.Character and Players.LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
				if hrp then hrp.CFrame = hrp.CFrame * CFrame.new(0,-1,0) end
			end
		end)
	end)
	flyDown.MouseLeave:Connect(function()
		if dis then dis:Disconnect(); dis = nil end
	end)
end

-- character added cleanup
Players.LocalPlayer.CharacterAdded:Connect(function(char)
	wait(0.7)
	local hum = Players.LocalPlayer.Character and Players.LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
	if hum then
		hum.PlatformStand = false
		Players.LocalPlayer.Character.Animate.Disabled = false
	end
end)

-- plus / minus speed
flyPlus.MouseButton1Down:Connect(function()
	fly_speeds = fly_speeds + 1
	flySpeedLabel.Text = tostring(fly_speeds)
	if nowe == true then
		tpwalking = false
		for i = 1, fly_speeds do
			spawn(function()
				local hb = RunService.Heartbeat
				tpwalking = true
				local chr = Players.LocalPlayer.Character
				local hum = chr and chr:FindFirstChildWhichIsA("Humanoid")
				while tpwalking and hb:Wait() and chr and hum and hum.Parent do
					if hum.MoveDirection.Magnitude > 0 then
						chr:TranslateBy(hum.MoveDirection)
					end
				end
			end)
		end
	end
end)

flyMinus.MouseButton1Down:Connect(function()
	if fly_speeds == 1 then
		flySpeedLabel.Text = 'cannot be less than 1'
		wait(1)
		flySpeedLabel.Text = tostring(fly_speeds)
	else
		fly_speeds = fly_speeds - 1
		flySpeedLabel.Text = tostring(fly_speeds)
		if nowe == true then
			tpwalking = false
			for i = 1, fly_speeds do
				spawn(function()
					local hb = RunService.Heartbeat
					tpwalking = true
					local chr = Players.LocalPlayer.Character
					local hum = chr and chr:FindFirstChildWhichIsA("Humanoid")
					while tpwalking and hb:Wait() and chr and hum and hum.Parent do
						if hum.MoveDirection.Magnitude > 0 then
							chr:TranslateBy(hum.MoveDirection)
						end
					end
				end)
			end
		end
	end
end)

-- fly minimize buttons behavior
flyMini.MouseButton1Click:Connect(function()
	flyUp.Visible = false
	flyDown.Visible = false
	flyOnOff.Visible = false
	flyPlus.Visible = false
	flySpeedLabel.Visible = false
	flyMinus.Visible = false
	flyMini.Visible = false
	flyMini2.Visible = true
	flyFrame.BackgroundTransparency = 1
	-- flyClose removed so no position update here
end)

flyMini2.MouseButton1Click:Connect(function()
	flyUp.Visible = true
	flyDown.Visible = true
	flyOnOff.Visible = true
	flyPlus.Visible = true
	flySpeedLabel.Visible = true
	flyMinus.Visible = true
	flyMini.Visible = true
	flyMini2.Visible = false
	flyFrame.BackgroundTransparency = 0
end)

-- ============================
-- === Integração Minimize / Restore / Cleanup ===
-- ============================
local function minimizeGUI()
	-- minimiza TP e Fly, mostra botão 0
	Frame.Visible = false
	flyFrame.Visible = false
	RestoreButton0.Visible = true
end

local function restoreGUI()
	Frame.Visible = true
	flyFrame.Visible = true
	RestoreButton0.Visible = false
end

safeConnect(MinimizeButton.MouseButton1Click, function()
	minimizeGUI()
end)

safeConnect(RestoreButton0.MouseButton1Click, function()
	restoreGUI()
end)

-- when TP close pressed -> cleanup everything
local function cleanup()
	if GUI then GUI.Enabled = false end
	for _,conn in pairs(connections) do
		if conn and conn.Disconnect and conn.Connected ~= false then
			pcall(function() conn:Disconnect() end)
		end
	end
	connections = {}
	for _,obj in ipairs(workspace:GetDescendants()) do
		if obj:IsA("Highlight") and obj.Name == "TeleportHighlight" then obj:Destroy() end
	end
	if GUI then GUI:Destroy() end
	if flyMain and flyMain.Parent then flyMain:Destroy() end
end

safeConnect(CloseButton.MouseButton1Click, cleanup)

-- === Drag GUI (TP Frame) ===
local dragInput,mousePos,framePos
safeConnect(Frame.InputBegan,function(input)
	if GUI.Enabled==false then return end
	if input.UserInputType==Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then
		dragInput=input
		mousePos=UIS:GetMouseLocation()
		framePos=Frame.Position
		safeConnect(input.Changed,function()
			if dragInput and dragInput.UserInputState==Enum.UserInputState.End then dragInput=nil end
		end)
	end
end)

safeConnect(RunService.Heartbeat,function()
	if dragInput and GUI.Enabled and Frame.Visible then
		local delta=UIS:GetMouseLocation()-mousePos
		Frame.Position=UDim2.new(framePos.X.Scale,framePos.X.Offset+delta.X,framePos.Y.Scale,framePos.Y.Offset+delta.Y)
	end
end)

-- ============================
-- === Drag & Move botão 0 (restore) ao clicar e segurar no celular ===
-- === WITH CLAMP TO VIEWPORT (limits) ===
-- ============================
local draggingRestoreInput = nil
local restoreDragStartPos = nil
local restoreButtonStartPos = nil

RestoreButton0.InputBegan:Connect(function(input)
	if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then
		draggingRestoreInput = input
		restoreDragStartPos = input.Position
		restoreButtonStartPos = RestoreButton0.Position
		input.Changed:Connect(function()
			if draggingRestoreInput == input and input.UserInputState == Enum.UserInputState.End then
				draggingRestoreInput = nil
			end
		end)
	end
end)

safeConnect(RunService.Heartbeat, function()
	if draggingRestoreInput and RestoreButton0.Visible then
		local currentPos
		pcall(function() currentPos = draggingRestoreInput.Position end)
		if not currentPos then currentPos = UIS:GetMouseLocation() end
		if currentPos and restoreDragStartPos and restoreButtonStartPos then
			local delta = currentPos - restoreDragStartPos
			-- desired offsets in pixels relative to scale origin
			local desiredOffsetX = restoreButtonStartPos.X.Offset + delta.X
			local desiredOffsetY = restoreButtonStartPos.Y.Offset + delta.Y
			-- compute viewport size and clamp range
			local viewportX, viewportY = 0, 0
			local ok = pcall(function()
				local vs = workspace.CurrentCamera and workspace.CurrentCamera.ViewportSize
				if vs then viewportX, viewportY = vs.X, vs.Y end
			end)
			-- fallback to 1280x720 if cannot get
			if viewportX == 0 or viewportY == 0 then
				viewportX, viewportY = 1280, 720
			end
			-- compute absolute position (pixels) of the scale anchor
			local anchorXPixels = viewportX * restoreButtonStartPos.X.Scale
			local anchorYPixels = viewportY * restoreButtonStartPos.Y.Scale
			-- compute final absolute desired position
			local finalAbsX = anchorXPixels + desiredOffsetX
			local finalAbsY = anchorYPixels + desiredOffsetY
			-- ensure RestoreButton0.AbsoluteSize is available
			local btnW, btnH = 48, 48
			pcall(function()
				if RestoreButton0.AbsoluteSize and RestoreButton0.AbsoluteSize.X and RestoreButton0.AbsoluteSize.Y then
					btnW, btnH = RestoreButton0.AbsoluteSize.X, RestoreButton0.AbsoluteSize.Y
				end
			end)
			-- clamp to screen (keep fully visible)
			local minX, minY = 0, 0
			local maxX, maxY = viewportX - btnW, viewportY - btnH
			finalAbsX = math.clamp(finalAbsX, minX, maxX)
			finalAbsY = math.clamp(finalAbsY, minY, maxY)
			-- convert back to offsets keeping original scale component
			local newOffsetX = finalAbsX - anchorXPixels
			local newOffsetY = finalAbsY - anchorYPixels
			RestoreButton0.Position = UDim2.new(restoreButtonStartPos.X.Scale, newOffsetX, restoreButtonStartPos.Y.Scale, newOffsetY)
		end
	end
end)

RestoreButton0.InputEnded:Connect(function(input)
	if draggingRestoreInput == input then draggingRestoreInput = nil end
end)

-- Make sure Restore button hides when Frame or flyFrame visible
safeConnect(RunService.Heartbeat, function()
	if Frame.Visible or (flyFrame and flyFrame.Visible) then
		if RestoreButton0.Visible then RestoreButton0.Visible = false end
	end
end)

-- ============================
-- === Horses logic (TP) ===
-- ============================
local validModels = {}
local currentModelIndex = 1

local function findValidModels()
	local islandsFolder = workspace:FindFirstChild("Islands")
	if not islandsFolder then return {}, "Erro: Islands Missing" end
	for _, obj in ipairs(workspace:GetDescendants()) do
		if obj:IsA("Highlight") and obj.Name == "TeleportHighlight" then obj:Destroy() end
	end
	local playerIslandFolder = Character and Character.Parent
	local islandContainer = nil
	while playerIslandFolder and playerIslandFolder ~= islandsFolder and playerIslandFolder ~= workspace do
		if playerIslandFolder.Parent == islandsFolder then islandContainer = playerIslandFolder break end
		playerIslandFolder = playerIslandFolder.Parent
	end
	if not islandContainer then return {}, "Erro: Não na Ilha" end
	local islandName = islandContainer.Name
	local wildHorses = {}
	local otherHorses = {}
	local themeColors = THEMES.Discord
	for _, descendant in ipairs(islandContainer:GetDescendants()) do
		if descendant:IsA("Model") and descendant:FindFirstChildOfClass("Humanoid") and descendant:FindFirstChild("HumanoidRootPart") and descendant.Name:match("^%b{}$") then
			local rootPart = descendant.HumanoidRootPart
			local hasCaptureProgress = false
			for _, element in ipairs(descendant:GetDescendants()) do
				if element.Name == "CaptureProgress" then hasCaptureProgress=true break end
			end
			local highlight = Instance.new("Highlight")
			highlight.Name = "TeleportHighlight"
			highlight.FillColor = hasCaptureProgress and themeColors.WarningBG_Wild or themeColors.ButtonTP
			highlight.OutlineColor = Color3.fromRGB(255,255,255)
			highlight.FillTransparency = 0.5
			highlight.OutlineTransparency = 0
			highlight.Adornee = descendant
			highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
			highlight.Parent = descendant
			local horseData = {Model=descendant,RootPart=rootPart,IsWild=hasCaptureProgress}
			if horseData.IsWild then table.insert(wildHorses,horseData) else table.insert(otherHorses,horseData) end
		end
	end
	table.sort(wildHorses,function(a,b)return a.Model.Name<b.Model.Name end)
	table.sort(otherHorses,function(a,b)return a.Model.Name<b.Model.Name end)
	local allHorses={}
	for _,h in ipairs(wildHorses) do table.insert(allHorses,h) end
	for _,h in ipairs(otherHorses) do table.insert(allHorses,h) end
	return allHorses,islandName
end

local function checkCurrentModelStatus()
	if GUI.Enabled==false or #validModels==0 or currentModelIndex>#validModels then WarningLabel.Visible=false return end
	local modelInfo = validModels[currentModelIndex]
	local currentModel = modelInfo.Model
	local isWildNow=false
	for _,element in ipairs(currentModel:GetDescendants()) do if element.Name=="CaptureProgress" then isWildNow=true break end end
	modelInfo.IsWild=isWildNow
	if isWildNow then
		WarningLabel.Text="É CAVALO SELVAGEM (LIVE)"
		WarningLabel.BackgroundColor3=THEMES.Discord.WarningBG_Wild
		WarningLabel.Visible=true
	else
		WarningLabel.Text="NÃO É CAVALO SELVAGEM (LIVE)"
		WarningLabel.BackgroundColor3=THEMES.Discord.WarningBG_Other
		WarningLabel.Visible=true
	end
end

local function updateGUIStatus()
	if #validModels==0 then StatusLabel.Text="Nenhum cavalo encontrado com nome entre { }" WarningLabel.Visible=false return end
	local modelInfo = validModels[currentModelIndex]
	local pos=modelInfo.RootPart.Position
	StatusLabel.Text=string.format("Cavalo %d de %d:\n%s\nPosição: %.1f, %.1f, %.1f",currentModelIndex,#validModels,modelInfo.Model.Name,pos.X,pos.Y,pos.Z)
	checkCurrentModelStatus()
end

local function teleportToNextModel()
	if GUI.Enabled==false or #validModels==0 then return end
	currentModelIndex+=1
	if currentModelIndex>#validModels then currentModelIndex=1 end
	local target=validModels[currentModelIndex]
	if target and target.Model and target.RootPart and Character then
		Character:PivotTo(CFrame.new(target.RootPart.Position + Vector3.new(0,3,0)))
		updateGUIStatus()
	end
end

local function refreshHorseList()
	if GUI.Enabled==false then return end
	validModels,currentModelIndex = findValidModels()
	currentModelIndex=1
	local islandName=validModels and validModels[1] and validModels[1].Model and validModels[1].Model.Parent and validModels[1].Model.Parent.Name or "Desconhecida"
	IslandLabel.Text="Ilha: "..islandName
	updateGUIStatus()
end

safeConnect(TeleportButton.MouseButton1Click,teleportToNextModel)
safeConnect(RefreshButton.MouseButton1Click,refreshHorseList)

safeConnect(RunService.Heartbeat,checkCurrentModelStatus)

-- initial setup
applyTheme()
refreshHorseList()
GUI.Enabled = true
flyMain.Enabled = true -- mostra Fly gui automaticamente junto com TP

-- end of script
