local Player = game:GetService("Players").LocalPlayer
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local Character
local Humanoid
local connections = {}

local THEMES = {
	Discord = {
		FrameBG = Color3.fromRGB(54, 57, 63),
		TextPrimary = Color3.fromRGB(255, 255, 255),
		TextSecondary = Color3.fromRGB(180, 180, 180),
		ButtonTP = Color3.fromRGB(88, 101, 242),
		ButtonRefresh = Color3.fromRGB(67, 181, 129),
		ButtonClose = Color3.fromRGB(237, 66, 69),
		WarningBG_Wild = Color3.fromRGB(67, 181, 129),
		WarningBG_Other = Color3.fromRGB(255, 69, 0),
		WarningText = Color3.fromRGB(255, 255, 255),
		CornerRadius = UDim.new(0, 8),
		ButtonCorner = UDim.new(0, 6),
		StrokeColor = Color3.fromRGB(40, 42, 46),
		StrokeThickness = 1,
		StrokeTransparency = 0
	}
}

local function safeConnect(signal, func)
	local conn = signal:Connect(func)
	table.insert(connections, conn)
	return conn
end

local function setupCharacter(char)
	Character = char
	Humanoid = char:WaitForChild("Humanoid")
end

setupCharacter(Player.Character or Player.CharacterAdded:Wait())
safeConnect(Player.CharacterAdded, setupCharacter)

-- === GUI Setup ===
local GUI = Instance.new("ScreenGui")
local Frame = Instance.new("Frame")
local TitleLabel = Instance.new("TextLabel")
local IslandLabel = Instance.new("TextLabel")
local StatusLabel = Instance.new("TextLabel")
local WarningLabel = Instance.new("TextLabel")
local TeleportButton = Instance.new("TextButton")
local RefreshButton = Instance.new("TextButton")
local FlyButton = Instance.new("TextButton")
local CloseButton = Instance.new("TextButton")

local FrameCorner = Instance.new("UICorner")
local TeleportCorner = Instance.new("UICorner")
local RefreshCorner = Instance.new("UICorner")
local FlyCorner = Instance.new("UICorner")
local CloseCorner = Instance.new("UICorner")
local WarningCorner = Instance.new("UICorner")

local FrameStroke = Instance.new("UIStroke")
local TeleportStroke = Instance.new("UIStroke")
local RefreshStroke = Instance.new("UIStroke")
local FlyStroke = Instance.new("UIStroke")
local CloseStroke = Instance.new("UIStroke")
local WarningStroke = Instance.new("UIStroke")

FrameCorner.Parent = Frame
TeleportCorner.Parent = TeleportButton
RefreshCorner.Parent = RefreshButton
FlyCorner.Parent = FlyButton
CloseCorner.Parent = CloseButton
WarningCorner.Parent = WarningLabel

FrameStroke.Parent = Frame
TeleportStroke.Parent = TeleportButton
RefreshStroke.Parent = RefreshButton
FlyStroke.Parent = FlyButton
CloseStroke.Parent = CloseButton
WarningStroke.Parent = WarningLabel

GUI.Name = "TeleportGUI"
GUI.Parent = Player:WaitForChild("PlayerGui")
GUI.ResetOnSpawn = false

Frame.Name = "TPFrame"
Frame.Size = UDim2.new(0, 320, 0, 240)
Frame.Position = UDim2.new(0.5, -160, 0.5, -120)
Frame.AnchorPoint = Vector2.new(0.5, 0.5)
Frame.BorderSizePixel = 0
Frame.Parent = GUI

TitleLabel.Size = UDim2.new(1, -40, 0, 30)
TitleLabel.Position = UDim2.new(0, 10, 0, 5)
TitleLabel.Text = "TP Em Cavalos Feito por FELIPE"
TitleLabel.Font = Enum.Font.SourceSansSemibold
TitleLabel.TextSize = 20
TitleLabel.BackgroundTransparency = 1
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.Parent = Frame

IslandLabel.Name = "IslandLabel"
IslandLabel.Size = UDim2.new(1, -40, 0, 20)
IslandLabel.Position = UDim2.new(0, 10, 0, 35)
IslandLabel.Text = "Ilha: Buscando..."
IslandLabel.Font = Enum.Font.SourceSans
IslandLabel.TextSize = 14
IslandLabel.BackgroundTransparency = 1
IslandLabel.TextXAlignment = Enum.TextXAlignment.Left
IslandLabel.Parent = Frame

CloseButton.Size = UDim2.new(0, 28, 0, 28)
CloseButton.Position = UDim2.new(1, -35, 0, 6)
CloseButton.Text = "X"
CloseButton.Font = Enum.Font.SourceSansBold
CloseButton.TextSize = 18
CloseButton.AutoButtonColor = false
CloseButton.Parent = Frame

StatusLabel.Size = UDim2.new(1, -20, 0.3, 0)
StatusLabel.Position = UDim2.new(0, 10, 0.25, 0)
StatusLabel.Font = Enum.Font.SourceSans
StatusLabel.TextSize = 16
StatusLabel.TextWrapped = true
StatusLabel.TextYAlignment = Enum.TextYAlignment.Top
StatusLabel.BackgroundTransparency = 1
StatusLabel.Parent = Frame

WarningLabel.Name = "WarningLabel"
WarningLabel.Size = UDim2.new(1, -20, 0, 30)
WarningLabel.Position = UDim2.new(0, 10, 0.55, 0)
WarningLabel.Text = "..."
WarningLabel.Font = Enum.Font.SourceSansSemibold
WarningLabel.TextSize = 16
WarningLabel.TextColor3 = THEMES.Discord.WarningText
WarningLabel.BackgroundColor3 = THEMES.Discord.WarningBG_Other
WarningLabel.BorderSizePixel = 0
WarningLabel.Visible = false
WarningLabel.Parent = Frame
WarningCorner.CornerRadius = UDim.new(0, 5)

TeleportButton.Size = UDim2.new(0, 93, 0, 40)
TeleportButton.Position = UDim2.new(0, 10, 0.78, 0)
TeleportButton.Text = "TP"
TeleportButton.Font = Enum.Font.SourceSansSemibold
TeleportButton.TextSize = 18
TeleportButton.AutoButtonColor = false
TeleportButton.Parent = Frame

RefreshButton.Size = UDim2.new(0, 93, 0, 40)
RefreshButton.Position = UDim2.new(0, 114, 0.78, 0)
RefreshButton.Text = "Busca"
RefreshButton.Font = Enum.Font.SourceSansSemibold
RefreshButton.TextSize = 18
RefreshButton.AutoButtonColor = false
RefreshButton.Parent = Frame

FlyButton.Size = UDim2.new(0, 93, 0, 40)
FlyButton.Position = UDim2.new(1, -103, 0.78, 0)
FlyButton.Text = "Fly"
FlyButton.Font = Enum.Font.SourceSansSemibold
FlyButton.TextSize = 18
FlyButton.AutoButtonColor = false
FlyButton.Parent = Frame

-- === Theme ===
local function applyTheme()
	local theme = THEMES.Discord
	Frame.BackgroundColor3 = theme.FrameBG
	FrameCorner.CornerRadius = theme.CornerRadius
	FrameStroke.Color = theme.StrokeColor
	FrameStroke.Thickness = theme.StrokeThickness
	FrameStroke.Transparency = theme.StrokeTransparency
	TitleLabel.TextColor3 = theme.TextPrimary
	StatusLabel.TextColor3 = theme.TextPrimary
	IslandLabel.TextColor3 = theme.TextSecondary
	WarningLabel.TextColor3 = theme.WarningText
	WarningStroke.Color = theme.StrokeColor
	WarningStroke.Thickness = theme.StrokeThickness
	WarningStroke.Transparency = theme.StrokeTransparency
	TeleportButton.BackgroundColor3 = theme.ButtonTP
	RefreshButton.BackgroundColor3 = theme.ButtonRefresh
	CloseButton.BackgroundColor3 = theme.ButtonClose
	FlyButton.BackgroundColor3 = Color3.fromRGB(237,66,69)
	TeleportButton.TextColor3 = theme.TextPrimary
	RefreshButton.TextColor3 = theme.TextPrimary
	FlyButton.TextColor3 = theme.TextPrimary
	CloseButton.TextColor3 = theme.TextPrimary
	local bCorner = theme.ButtonCorner
	TeleportCorner.CornerRadius = bCorner
	RefreshCorner.CornerRadius = bCorner
	FlyCorner.CornerRadius = bCorner
	CloseCorner.CornerRadius = bCorner
	local bStrokeColor = theme.StrokeColor
	local bStrokeThickness = theme.StrokeThickness
	local bStrokeTransparency = theme.StrokeTransparency
	TeleportStroke.Color = bStrokeColor
	TeleportStroke.Thickness = bStrokeThickness
	TeleportStroke.Transparency = bStrokeTransparency
	RefreshStroke.Color = bStrokeColor
	RefreshStroke.Thickness = bStrokeThickness
	RefreshStroke.Transparency = bStrokeTransparency
	FlyStroke.Color = bStrokeColor
	FlyStroke.Thickness = bStrokeThickness
	FlyStroke.Transparency = bStrokeTransparency
	CloseStroke.Color = bStrokeColor
	CloseStroke.Thickness = bStrokeThickness
	CloseStroke.Transparency = bStrokeTransparency
end

-- === Horses ===
local validModels = {}
local currentModelIndex = 1

local function findValidModels()
	local islandsFolder = workspace:FindFirstChild("Islands")
	if not islandsFolder then return {}, "Erro: Islands Missing" end
	for _, obj in ipairs(workspace:GetDescendants()) do
		if obj:IsA("Highlight") and obj.Name == "TeleportHighlight" then obj:Destroy() end
	end
	local playerIslandFolder = Character and Character.Parent
	local islandContainer = nil
	while playerIslandFolder and playerIslandFolder ~= islandsFolder and playerIslandFolder ~= workspace do
		if playerIslandFolder.Parent == islandsFolder then islandContainer = playerIslandFolder break end
		playerIslandFolder = playerIslandFolder.Parent
	end
	if not islandContainer then return {}, "Erro: Não na Ilha" end
	local islandName = islandContainer.Name
	local wildHorses = {}
	local otherHorses = {}
	local themeColors = THEMES.Discord
	for _, descendant in ipairs(islandContainer:GetDescendants()) do
		if descendant:IsA("Model") and descendant:FindFirstChildOfClass("Humanoid") and descendant:FindFirstChild("HumanoidRootPart") and descendant.Name:match("^%b{}$") then
			local rootPart = descendant.HumanoidRootPart
			local hasCaptureProgress = false
			for _, element in ipairs(descendant:GetDescendants()) do
				if element.Name == "CaptureProgress" then hasCaptureProgress=true break end
			end
			local highlight = Instance.new("Highlight")
			highlight.Name = "TeleportHighlight"
			highlight.FillColor = hasCaptureProgress and themeColors.WarningBG_Wild or themeColors.ButtonTP
			highlight.OutlineColor = Color3.fromRGB(255,255,255)
			highlight.FillTransparency = 0.5
			highlight.OutlineTransparency = 0
			highlight.Adornee = descendant
			highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
			highlight.Parent = descendant
			local horseData = {Model=descendant,RootPart=rootPart,IsWild=hasCaptureProgress}
			if horseData.IsWild then table.insert(wildHorses,horseData) else table.insert(otherHorses,horseData) end
		end
	end
	table.sort(wildHorses,function(a,b)return a.Model.Name<b.Model.Name end)
	table.sort(otherHorses,function(a,b)return a.Model.Name<b.Model.Name end)
	local allHorses={}
	for _,h in ipairs(wildHorses) do table.insert(allHorses,h) end
	for _,h in ipairs(otherHorses) do table.insert(allHorses,h) end
	return allHorses,islandName
end

local function checkCurrentModelStatus()
	if GUI.Enabled==false or #validModels==0 or currentModelIndex>#validModels then WarningLabel.Visible=false return end
	local modelInfo = validModels[currentModelIndex]
	local currentModel = modelInfo.Model
	local isWildNow=false
	for _,element in ipairs(currentModel:GetDescendants()) do if element.Name=="CaptureProgress" then isWildNow=true break end end
	modelInfo.IsWild=isWildNow
	if isWildNow then
		WarningLabel.Text="É CAVALO SELVAGEM (LIVE)"
		WarningLabel.BackgroundColor3=THEMES.Discord.WarningBG_Wild
		WarningLabel.Visible=true
	else
		WarningLabel.Text="NÃO É CAVALO SELVAGEM (LIVE)"
		WarningLabel.BackgroundColor3=THEMES.Discord.WarningBG_Other
		WarningLabel.Visible=true
	end
end

local function updateGUIStatus()
	if #validModels==0 then StatusLabel.Text="Nenhum cavalo encontrado com nome entre { }" WarningLabel.Visible=false return end
	local modelInfo = validModels[currentModelIndex]
	local pos=modelInfo.RootPart.Position
	StatusLabel.Text=string.format("Cavalo %d de %d:\n%s\nPosição: %.1f, %.1f, %.1f",currentModelIndex,#validModels,modelInfo.Model.Name,pos.X,pos.Y,pos.Z)
	checkCurrentModelStatus()
end

local function teleportToNextModel()
	if GUI.Enabled==false or #validModels==0 then return end
	currentModelIndex+=1
	if currentModelIndex>#validModels then currentModelIndex=1 end
	local target=validModels[currentModelIndex]
	if target and target.Model and target.RootPart and Character then
		Character:PivotTo(CFrame.new(target.RootPart.Position + Vector3.new(0,3,0)))
		updateGUIStatus()
	end
end

local function refreshHorseList()
	if GUI.Enabled==false then return end
	validModels,currentModelIndex = findValidModels()
	currentModelIndex=1
	local islandName=validModels and validModels[1] and validModels[1].Model and validModels[1].Model.Parent and validModels[1].Model.Parent.Name or "Desconhecida"
	IslandLabel.Text="Ilha: "..islandName
	updateGUIStatus()
end

local function cleanup()
	if GUI then GUI.Enabled=false end
	for _,conn in pairs(connections) do if conn:IsConnected() then conn:Disconnect() end end
	connections={}
	for _,obj in ipairs(workspace:GetDescendants()) do if obj:IsA("Highlight") and obj.Name=="TeleportHighlight" then obj:Destroy() end end
	if GUI then GUI:Destroy() end
end

safeConnect(TeleportButton.MouseButton1Click,teleportToNextModel)
safeConnect(RefreshButton.MouseButton1Click,refreshHorseList)
safeConnect(CloseButton.MouseButton1Click,cleanup)

-- === Novo Fly System ===
local flyEnabled = false
local flyEnabled = false
local flySpeed = 300
local flyBodyVelocity
local flyBodyGyro

local function createFlyParts()
	if not Character then return end
	local hrp = Character:FindFirstChild("HumanoidRootPart")
	if not hrp then return end

	if flyBodyVelocity then flyBodyVelocity:Destroy() end
	if flyBodyGyro then flyBodyGyro:Destroy() end

	flyBodyVelocity = Instance.new("BodyVelocity")
	flyBodyVelocity.MaxForce = Vector3.new(1e7, 1e7, 1e7)
	flyBodyVelocity.Velocity = Vector3.new(0, 0, 0)
	flyBodyVelocity.P = 1250
	flyBodyVelocity.Parent = hrp

	flyBodyGyro = Instance.new("BodyGyro")
	flyBodyGyro.MaxTorque = Vector3.new(1e7, 1e7, 1e7)
	flyBodyGyro.P = 3000
	flyBodyGyro.CFrame = hrp.CFrame
	flyBodyGyro.Parent = hrp
end

local function destroyFlyParts()
	if flyBodyVelocity then
		pcall(function() flyBodyVelocity:Destroy() end)
		flyBodyVelocity = nil
	end
	if flyBodyGyro then
		pcall(function() flyBodyGyro:Destroy() end)
		flyBodyGyro = nil
	end
end

local function toggleFly()
	if not Character then return end
	flyEnabled = not flyEnabled
	if flyEnabled then
		if FlyButton then FlyButton.BackgroundColor3 = Color3.fromRGB(0,255,0) end
		createFlyParts()
	else
		if FlyButton then FlyButton.BackgroundColor3 = Color3.fromRGB(237,66,69) end
		destroyFlyParts()
	end
end

safeConnect(FlyButton.Activated, toggleFly)

local function getHorizontalInput(cam)
	if Humanoid and Humanoid.MoveDirection and Humanoid.MoveDirection.Magnitude > 0 then
		local md = Humanoid.MoveDirection
		return Vector3.new(md.X, 0, md.Z)
	end
	if not cam then return Vector3.new() end
	local forward = Vector3.new(cam.LookVector.X, 0, cam.LookVector.Z)
	local right = Vector3.new(cam.RightVector.X, 0, cam.RightVector.Z)
	local dir = Vector3.new()
	if UIS:IsKeyDown(Enum.KeyCode.W) then dir = dir + forward end
	if UIS:IsKeyDown(Enum.KeyCode.S) then dir = dir - forward end
	if UIS:IsKeyDown(Enum.KeyCode.A) then dir = dir - right end
	if UIS:IsKeyDown(Enum.KeyCode.D) then dir = dir + right end
	return dir
end

safeConnect(RunService.Heartbeat, function()
	if not flyEnabled then return end
	if not Character or not Character.Parent then
		flyEnabled = false
		destroyFlyParts()
		return
	end
	local hrp = Character:FindFirstChild("HumanoidRootPart")
	local cam = workspace.CurrentCamera
	if not hrp or not cam then return end

	local inputDir = getHorizontalInput(cam)
	local horizVel = Vector3.new(0, 0, 0)
	if inputDir.Magnitude > 0 then
		horizVel = inputDir.Unit * flySpeed
	end

	local vert = 0
	if UIS:IsKeyDown(Enum.KeyCode.Space) then
		vert = flySpeed
	elseif UIS:IsKeyDown(Enum.KeyCode.LeftControl) then
		vert = -flySpeed
else
		local forwardMag = math.clamp(inputDir.Magnitude, 0, 1)
		vert = cam.CFrame.LookVector.Y * forwardMag * flySpeed
	end

	local target = Vector3.new(horizVel.X, vert, horizVel.Z)
	if target ~= target then target = Vector3.new(0,0,0) end

	if flyBodyVelocity then flyBodyVelocity.Velocity = target end
	if flyBodyGyro then flyBodyGyro.CFrame = CFrame.new(hrp.Position, hrp.Position + cam.CFrame.LookVector) end
end)

-- === Drag GUI ===
local dragInput,mousePos,framePos
safeConnect(Frame.InputBegan,function(input)
	if GUI.Enabled==false then return end
	if input.UserInputType==Enum.UserInputType.MouseButton1 or input.UserInputType==Enum.UserInputType.Touch then
		dragInput=input
		mousePos=UIS:GetMouseLocation()
		framePos=Frame.Position
		safeConnect(input.Changed,function()
			if dragInput and dragInput.UserInputState==Enum.UserInputState.End then dragInput=nil end
		end)
	end
end)

safeConnect(RunService.Heartbeat,function()
	if dragInput and GUI.Enabled then
		local delta=UIS:GetMouseLocation()-mousePos
		Frame.Position=UDim2.new(framePos.X.Scale,framePos.X.Offset+delta.X,framePos.Y.Scale,framePos.Y.Offset+delta.Y)
	end
end)

safeConnect(RunService.Heartbeat,checkCurrentModelStatus)

applyTheme()
refreshHorseList()
GUI.Enabled=true
