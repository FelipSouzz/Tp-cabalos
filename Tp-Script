local Player = game:GetService("Players").LocalPlayer
local UIS = game:GetService("UserInputService")
local RunService = game:GetService("RunService")

local Character
local Humanoid
local connections = {}

local THEMES = {
	Discord = {
		FrameBG = Color3.fromRGB(54, 57, 63),
		TextPrimary = Color3.fromRGB(255, 255, 255),
		TextSecondary = Color3.fromRGB(180, 180, 180),
		ButtonTP = Color3.fromRGB(88, 101, 242),
		ButtonRefresh = Color3.fromRGB(67, 181, 129),
		ButtonClose = Color3.fromRGB(237, 66, 69),
		WarningBG_Wild = Color3.fromRGB(67, 181, 129),
		WarningBG_Other = Color3.fromRGB(255, 69, 0),
		WarningText = Color3.fromRGB(255, 255, 255),
		CornerRadius = UDim.new(0, 8),
		ButtonCorner = UDim.new(0, 6),
		StrokeColor = Color3.fromRGB(40, 42, 46),
		StrokeThickness = 1,
		StrokeTransparency = 0
	}
}

local function safeConnect(signal, func)
	local conn = signal:Connect(func)
	table.insert(connections, conn)
	return conn
end

local function setupCharacter(char)
	Character = char
	Humanoid = char:WaitForChild("Humanoid")
end

setupCharacter(Player.Character or Player.CharacterAdded:Wait())
safeConnect(Player.CharacterAdded, setupCharacter)

-- === GUI Setup ===
local GUI = Instance.new("ScreenGui")
local Frame = Instance.new("Frame")
local TitleLabel = Instance.new("TextLabel")
local IslandLabel = Instance.new("TextLabel")
local StatusLabel = Instance.new("TextLabel")
local WarningLabel = Instance.new("TextLabel")
local TeleportButton = Instance.new("TextButton")
local RefreshButton = Instance.new("TextButton")
local FlyButton = Instance.new("TextButton")
local CloseButton = Instance.new("TextButton")

local FrameCorner = Instance.new("UICorner")
local TeleportCorner = Instance.new("UICorner")
local RefreshCorner = Instance.new("UICorner")
local FlyCorner = Instance.new("UICorner")
local CloseCorner = Instance.new("UICorner")
local WarningCorner = Instance.new("UICorner")

local FrameStroke = Instance.new("UIStroke")
local TeleportStroke = Instance.new("UIStroke")
local RefreshStroke = Instance.new("UIStroke")
local FlyStroke = Instance.new("UIStroke")
local CloseStroke = Instance.new("UIStroke")
local WarningStroke = Instance.new("UIStroke")

FrameCorner.Parent = Frame
TeleportCorner.Parent = TeleportButton
RefreshCorner.Parent = RefreshButton
FlyCorner.Parent = FlyButton
CloseCorner.Parent = CloseButton
WarningCorner.Parent = WarningLabel

FrameStroke.Parent = Frame
TeleportStroke.Parent = TeleportButton
RefreshStroke.Parent = RefreshButton
FlyStroke.Parent = FlyButton
CloseStroke.Parent = CloseButton
WarningStroke.Parent = WarningLabel

GUI.Name = "TeleportGUI"
GUI.Parent = Player:WaitForChild("PlayerGui")
GUI.ResetOnSpawn = false

Frame.Name = "TPFrame"
Frame.Size = UDim2.new(0, 320, 0, 260) -- a little taller to fit speed controls
Frame.Position = UDim2.new(0.5, -160, 0.5, -130)
Frame.AnchorPoint = Vector2.new(0.5, 0.5)
Frame.BorderSizePixel = 0
Frame.Parent = GUI

TitleLabel.Size = UDim2.new(1, -40, 0, 30)
TitleLabel.Position = UDim2.new(0, 10, 0, 5)
TitleLabel.Text = "TP Horse"
TitleLabel.Font = Enum.Font.SourceSansSemibold
TitleLabel.TextSize = 20
TitleLabel.BackgroundTransparency = 1
TitleLabel.TextXAlignment = Enum.TextXAlignment.Left
TitleLabel.Parent = Frame

IslandLabel.Name = "IslandLabel"
IslandLabel.Size = UDim2.new(1, -40, 0, 20)
IslandLabel.Position = UDim2.new(0, 10, 0, 35)
IslandLabel.Text = "Ilha: Buscando..."
IslandLabel.Font = Enum.Font.SourceSans
IslandLabel.TextSize = 14
IslandLabel.BackgroundTransparency = 1
IslandLabel.TextXAlignment = Enum.TextXAlignment.Left
IslandLabel.Parent = Frame

CloseButton.Size = UDim2.new(0, 28, 0, 28)
CloseButton.Position = UDim2.new(1, -35, 0, 6)
CloseButton.Text = "X"
CloseButton.Font = Enum.Font.SourceSansBold
CloseButton.TextSize = 18
CloseButton.AutoButtonColor = false
CloseButton.Parent = Frame

StatusLabel.Size = UDim2.new(1, -20, 0.32, 0)
StatusLabel.Position = UDim2.new(0, 10, 0.25, 0)
StatusLabel.Font = Enum.Font.SourceSans
StatusLabel.TextSize = 16
StatusLabel.TextWrapped = true
StatusLabel.TextYAlignment = Enum.TextYAlignment.Top
StatusLabel.BackgroundTransparency = 1
StatusLabel.Parent = Frame

WarningLabel.Name = "WarningLabel"
WarningLabel.Size = UDim2.new(1, -20, 0, 30)
WarningLabel.Position = UDim2.new(0, 10, 0.6, 0)
WarningLabel.Text = "..."
WarningLabel.Font = Enum.Font.SourceSansSemibold
WarningLabel.TextSize = 16
WarningLabel.TextColor3 = THEMES.Discord.WarningText
WarningLabel.BackgroundColor3 = THEMES.Discord.WarningBG_Other
WarningLabel.BorderSizePixel = 0
WarningLabel.Visible = false
WarningLabel.Parent = Frame
WarningCorner.CornerRadius = UDim.new(0, 5)

TeleportButton.Size = UDim2.new(0, 93, 0, 40)
TeleportButton.Position = UDim2.new(0, 10, 0.78, 0)
TeleportButton.Text = "TP"
TeleportButton.Font = Enum.Font.SourceSansSemibold
TeleportButton.TextSize = 18
TeleportButton.AutoButtonColor = false
TeleportButton.Parent = Frame

RefreshButton.Size = UDim2.new(0, 93, 0, 40)
RefreshButton.Position = UDim2.new(0, 114, 0.78, 0)
RefreshButton.Text = "Busca"
RefreshButton.Font = Enum.Font.SourceSansSemibold
RefreshButton.TextSize = 18
RefreshButton.AutoButtonColor = false
RefreshButton.Parent = Frame

FlyButton.Size = UDim2.new(0, 93, 0, 40)
FlyButton.Position = UDim2.new(1, -103, 0.78, 0)
FlyButton.Text = "Fly"
FlyButton.Font = Enum.Font.SourceSansSemibold
FlyButton.TextSize = 18
FlyButton.AutoButtonColor = false
FlyButton.Parent = Frame

-- Speed controls (new): minus, label, plus
local SpeedMinus = Instance.new("TextButton", Frame)
local SpeedLabel = Instance.new("TextLabel", Frame)
local SpeedPlus = Instance.new("TextButton", Frame)

SpeedMinus.Size = UDim2.new(0, 36, 0, 28)
SpeedMinus.Position = UDim2.new(1, -203, 0.78, 6)
SpeedMinus.Text = "−"
SpeedMinus.Font = Enum.Font.SourceSansBold
SpeedMinus.TextSize = 20
SpeedMinus.AutoButtonColor = false

SpeedLabel.Size = UDim2.new(0, 44, 0, 28)
SpeedLabel.Position = UDim2.new(1, -166, 0.78, 6)
SpeedLabel.Text = "3.0"
SpeedLabel.Font = Enum.Font.SourceSans
SpeedLabel.TextSize = 16
SpeedLabel.BackgroundTransparency = 0
SpeedLabel.TextColor3 = THEMES.Discord.TextPrimary
SpeedLabel.TextScaled = false

SpeedPlus.Size = UDim2.new(0, 36, 0, 28)
SpeedPlus.Position = UDim2.new(1, -118, 0.78, 6)
SpeedPlus.Text = "+"
SpeedPlus.Font = Enum.Font.SourceSansBold
SpeedPlus.TextSize = 18
SpeedPlus.AutoButtonColor = false

-- corners for speed UI
local smCorner = Instance.new("UICorner", SpeedMinus)
local slCorner = Instance.new("UICorner", SpeedLabel)
local spCorner = Instance.new("UICorner", SpeedPlus)

-- Strokes for speed UI
local smStroke = Instance.new("UIStroke", SpeedMinus)
local slStroke = Instance.new("UIStroke", SpeedLabel)
local spStroke = Instance.new("UIStroke", SpeedPlus)

-- === Theme application ===
local function applyTheme()
	local theme = THEMES.Discord
	Frame.BackgroundColor3 = theme.FrameBG
	FrameCorner.CornerRadius = theme.CornerRadius
	FrameStroke.Color = theme.StrokeColor
	FrameStroke.Thickness = theme.StrokeThickness
	FrameStroke.Transparency = theme.StrokeTransparency
	TitleLabel.TextColor3 = theme.TextPrimary
	StatusLabel.TextColor3 = theme.TextPrimary
	IslandLabel.TextColor3 = theme.TextSecondary
	WarningLabel.TextColor3 = theme.WarningText
	WarningStroke.Color = theme.StrokeColor
	WarningStroke.Thickness = theme.StrokeThickness
	WarningStroke.Transparency = theme.StrokeTransparency
	TeleportButton.BackgroundColor3 = theme.ButtonTP
	RefreshButton.BackgroundColor3 = theme.ButtonRefresh
	CloseButton.BackgroundColor3 = theme.ButtonClose
	FlyButton.BackgroundColor3 = Color3.fromRGB(237,66,69) -- off = red
	TeleportButton.TextColor3 = theme.TextPrimary
	RefreshButton.TextColor3 = theme.TextPrimary
	FlyButton.TextColor3 = theme.TextPrimary
	CloseButton.TextColor3 = theme.TextPrimary

	-- style speed UI to match
	SpeedMinus.BackgroundColor3 = theme.ButtonTP
	SpeedPlus.BackgroundColor3 = theme.ButtonRefresh
	SpeedLabel.BackgroundColor3 = theme.FrameBG
	SpeedLabel.TextColor3 = theme.TextPrimary

	local bCorner = theme.ButtonCorner
	TeleportCorner.CornerRadius = bCorner
	RefreshCorner.CornerRadius = bCorner
	FlyCorner.CornerRadius = bCorner
	CloseCorner.CornerRadius = bCorner

	smCorner.CornerRadius = UDim.new(0, 6)
	slCorner.CornerRadius = UDim.new(0, 6)
	spCorner.CornerRadius = UDim.new(0, 6)

	local bStrokeColor = theme.StrokeColor
	local bStrokeThickness = theme.StrokeThickness
	local bStrokeTransparency = theme.StrokeTransparency
	TeleportStroke.Color = bStrokeColor
	TeleportStroke.Thickness = bStrokeThickness
	TeleportStroke.Transparency = bStrokeTransparency
	RefreshStroke.Color = bStrokeColor
	RefreshStroke.Thickness = bStrokeThickness
	RefreshStroke.Transparency = bStrokeTransparency
	FlyStroke.Color = bStrokeColor
	FlyStroke.Thickness = bStrokeThickness
	FlyStroke.Transparency = bStrokeTransparency
	CloseStroke.Color = bStrokeColor
	CloseStroke.Thickness = bStrokeThickness
	CloseStroke.Transparency = bStrokeTransparency

	smStroke.Color = bStrokeColor
	smStroke.Thickness = bStrokeThickness
	smStroke.Transparency = bStrokeTransparency
	slStroke.Color = bStrokeColor
	slStroke.Thickness = bStrokeThickness
	slStroke.Transparency = bStrokeTransparency
	spStroke.Color = bStrokeColor
	spStroke.Thickness = bStrokeThickness
	spStroke.Transparency = bStrokeTransparency
end

-- === Horses ===
local validModels = {}
local currentModelIndex = 1

local function findValidModels()
	local islandsFolder = workspace:FindFirstChild("Islands")
	if not islandsFolder then return {}, "Erro: Islands Missing" end
	for _, obj in ipairs(workspace:GetDescendants()) do
		if obj:IsA("Highlight") and obj.Name == "TeleportHighlight" then obj:Destroy() end
	end
	local playerIslandFolder = Character and Character.Parent
	local islandContainer = nil
	while playerIslandFolder and playerIslandFolder ~= islandsFolder and playerIslandFolder ~= workspace do
		if playerIslandFolder.Parent == islandsFolder then islandContainer = playerIslandFolder break end
		playerIslandFolder = playerIslandFolder.Parent
	end
	if not islandContainer then return {}, "Erro: Não na Ilha" end
	local islandName = islandContainer.Name
	local wildHorses = {}
	local otherHorses = {}
	local themeColors = THEMES.Discord
	for _, descendant in ipairs(islandContainer:GetDescendants()) do
		if descendant:IsA("Model") and descendant:FindFirstChildOfClass("Humanoid") and descendant:FindFirstChild("HumanoidRootPart") and descendant.Name:match("^%b{}$") then
			local rootPart = descendant.HumanoidRootPart
			local hasCaptureProgress = false
			for _, element in ipairs(descendant:GetDescendants()) do
				if element.Name == "CaptureProgress" then hasCaptureProgress=true break end
			end
			local highlight = Instance.new("Highlight")
			highlight.Name = "TeleportHighlight"
			highlight.FillColor = hasCaptureProgress and themeColors.WarningBG_Wild or themeColors.ButtonTP
			highlight.OutlineColor = Color3.fromRGB(255,255,255)
			highlight.FillTransparency = 0.5
			highlight.OutlineTransparency = 0
			highlight.Adornee = descendant
			highlight.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
			highlight.Parent = descendant
			local horseData = {Model=descendant,RootPart=rootPart,IsWild=hasCaptureProgress}
			if horseData.IsWild then table.insert(wildHorses,horseData) else table.insert(otherHorses,horseData) end
		end
	end
	table.sort(wildHorses,function(a,b)return a.Model.Name<b.Model.Name end)
	table.sort(otherHorses,function(a,b)return a.Model.Name<b.Model.Name end)
	local allHorses={}
	for _,h in ipairs(wildHorses) do table.insert(allHorses,h) end
	for _,h in ipairs(otherHorses) do table.insert(allHorses,h) end
	return allHorses,islandName
end

local function checkCurrentModelStatus()
	if GUI.Enabled==false or #validModels==0 or currentModelIndex>#validModels then WarningLabel.Visible=false return end
	local modelInfo = validModels[currentModelIndex]
	local currentModel = modelInfo.Model
	local isWildNow=false
	for _,element in ipairs(currentModel:GetDescendants()) do if element.Name=="CaptureProgress" then isWildNow=true break end end
	modelInfo.IsWild=isWildNow
	if isWildNow then
		WarningLabel.Text="É CAVALO SELVAGEM (LIVE)"
		WarningLabel.BackgroundColor3=THEMES.Discord.WarningBG_Wild
		WarningLabel.Visible=true
	else
		WarningLabel.Text="NÃO É CAVALO SELVAGEM (LIVE)"
		WarningLabel.BackgroundColor3=THEMES.Discord.WarningBG_Other
		WarningLabel.Visible=true
	end
end

local function updateGUIStatus()
	if #validModels==0 then StatusLabel.Text="Nenhum cavalo encontrado com nome entre { }" WarningLabel.Visible=false return end
	local modelInfo = validModels[currentModelIndex]
	local pos=modelInfo.RootPart.Position
	StatusLabel.Text=string.format("Cavalo %d de %d:\n%s\nPosição: %.1f, %.1f, %.1f",currentModelIndex,#validModels,modelInfo.Model.Name,pos.X,pos.Y,pos.Z)
	checkCurrentModelStatus()
end

local function teleportToNextModel()
	if GUI.Enabled==false or #validModels==0 then return end
	currentModelIndex+=1
	if currentModelIndex>#validModels then currentModelIndex=1 end
	local target=validModels[currentModelIndex]
	if target and target.Model and target.RootPart and Character then
		Character:PivotTo(CFrame.new(target.RootPart.Position + Vector3.new(0,3,0)))
		updateGUIStatus()
	end
end

local function refreshHorseList()
	if GUI.Enabled==false then return end
	validModels, _ = findValidModels()
	currentModelIndex=1
	local islandName = "Desconhecida"
	if validModels and validModels[1] and validModels[1].Model and validModels[1].Model.Parent then
		islandName = validModels[1].Model.Parent.Name
	end
	IslandLabel.Text="Ilha: "..islandName
	updateGUIStatus()
end

local function cleanup()
	if GUI then GUI.Enabled=false end
	for _,conn in pairs(connections) do if conn:IsConnected() then conn:Disconnect() end end
	connections={}
	for _,obj in ipairs(workspace:GetDescendants()) do if obj:IsA("Highlight") and obj.Name=="TeleportHighlight" then obj:Destroy() end end
	if GUI then GUI:Destroy() end
end

safeConnect(TeleportButton.MouseButton1Click,teleportToNextModel)
safeConnect(RefreshButton.MouseButton1Click,refreshHorseList)
safeConnect(CloseButton.MouseButton1Click,cleanup)

-- === Fly: MOBILE ONLY, R15 ONLY, speed adjustable via GUI ===
local flyEnabled = false
local flySpeed = 3.0 -- default speed (matches your request)
local flyMin = 0.5
local flyMax = 20
local flyStep = 0.5

local flyBodyVelocity
local flyBodyGyro

local function isMobile()
	-- Consider touch devices as "mobile"
	return UIS.TouchEnabled == true
end

local function isR15()
	if Humanoid and Humanoid.RigType then
		return Humanoid.RigType == Enum.HumanoidRigType.R15
	end
	-- fallback: if Humanoid has UpperTorso, assume R15
	if Character then
		return Character:FindFirstChild("UpperTorso") ~= nil
	end
	return false
end

local function showTempWarning(text, timeSec)
	WarningLabel.Text = text
	WarningLabel.BackgroundColor3 = THEMES.Discord.WarningBG_Other
	WarningLabel.Visible = true
	delay(timeSec or 2, function()
		-- only hide if it wasn't overwritten by other systems
		if WarningLabel.Text == text then
			WarningLabel.Visible = false
		end
	end)
end

local function updateSpeedLabel()
	SpeedLabel.Text = string.format("%.1f", flySpeed)
end

local function startFly()
	if not Character then return end
	local hrp = Character:FindFirstChild("HumanoidRootPart")
	if not hrp then return end

	-- create BodyVelocity & BodyGyro
	flyBodyVelocity = Instance.new("BodyVelocity")
	flyBodyVelocity.MaxForce = Vector3.new(1e5, 1e5, 1e5)
	flyBodyVelocity.Velocity = Vector3.new(0, 0, 0)
	flyBodyVelocity.P = 1250
	flyBodyVelocity.Parent = hrp

	flyBodyGyro = Instance.new("BodyGyro")
	flyBodyGyro.MaxTorque = Vector3.new(1e5, 1e5, 1e5)
	flyBodyGyro.P = 3000
	flyBodyGyro.CFrame = hrp.CFrame
	flyBodyGyro.Parent = hrp
end

local function stopFly()
	if flyBodyVelocity then
		pcall(function() flyBodyVelocity:Destroy() end)
		flyBodyVelocity = nil
	end
	if flyBodyGyro then
		pcall(function() flyBodyGyro:Destroy() end)
		flyBodyGyro = nil
	end
end

local function toggleFly()
	if not Character then return end

	-- Enforce mobile + R15
	if not isMobile() then
		showTempWarning("Fly disponível somente no celular (touch).", 2.5)
		return
	end
	if not isR15() then
		showTempWarning("Fly disponível somente para R15.", 2.5)
		return
	end

	flyEnabled = not flyEnabled
	if flyEnabled then
		FlyButton.BackgroundColor3 = Color3.fromRGB(67, 181, 129) -- verde
		startFly()
	else
		FlyButton.BackgroundColor3 = Color3.fromRGB(237, 66, 69) -- vermelho
		stopFly()
	end
end

-- Speed controls handlers
safeConnect(SpeedPlus.MouseButton1Click, function()
	flySpeed = math.min(flyMax, math.floor((flySpeed + flyStep) * 10 + 0.5) / 10)
	updateSpeedLabel()
end)
safeConnect(SpeedMinus.MouseButton1Click, function()
	flySpeed = math.max(flyMin, math.floor((flySpeed - flyStep) * 10 + 0.5) / 10)
	updateSpeedLabel()
end)

-- Attach FlyButton (use Activated so it works for touch)
safeConnect(FlyButton.Activated, toggleFly)

-- Update fly each frame (uses Humanoid.MoveDirection and camera look for vertical)
safeConnect(RunService.Heartbeat, function(dt)
	if flyEnabled and Character and Character:FindFirstChild("HumanoidRootPart") then
		local hrp = Character:FindFirstChild("HumanoidRootPart")
		local cam = workspace.CurrentCamera
		if not hrp or not cam then return end

		-- Movement direction from mobile virtual joystick
		local moveDir = Vector3.new()
		-- Use Humanoid.MoveDirection (works on mobile)
		if Humanoid then
			moveDir = Humanoid.MoveDirection or Vector3.new()
		end

		-- If no horizontal input, still allow vertical via camera tilt when user touches/drag - but mobile doesn't have explicit vertical control
		-- We'll derive vertical speed from camera pitch * magnitude of movement input
		local camLook = cam.CFrame.LookVector
		local verticalComponent = 0
		local horizMag = Vector3.new(moveDir.X, 0, moveDir.Z).Magnitude

		-- If player is moving (horizMag > 0) we allow ascending/descending by camera pitch
		if horizMag > 0 then
			-- camLook.Y is positive when looking up, negative when looking down
			verticalComponent = camLook.Y * horizMag * flySpeed
		end

		-- Compose final velocity: horizontal follows Humanoid.MoveDirection, vertical from camera tilt
		local finalVel = Vector3.new(0,0,0)
		if moveDir.Magnitude > 0 then
			local horizontal = Vector3.new(moveDir.X, 0, moveDir.Z).Unit * flySpeed
			finalVel = Vector3.new(horizontal.X, verticalComponent, horizontal.Z)
		else
			-- no horizontal input: optionally hold vertical when the player drags camera + moves little -> keep minimal vertical
			finalVel = Vector3.new(0, verticalComponent, 0)
		end

		-- Safety clamps to avoid NaN
		if finalVel ~= finalVel then finalVel = Vector3.new(0,0,0) end

		if flyBodyVelocity then
			flyBodyVelocity.Velocity = finalVel
		end
		if flyBodyGyro then
			-- orient to camera forward for nicer feel
			flyBodyGyro.CFrame = CFrame.new(hrp.Position, hrp.Position + camLook)
		end
	end
end)

-- === Drag GUI ===
local dragInput, mousePos, framePos
safeConnect(Frame.InputBegan, function(input)
	if GUI.Enabled==false then return end
	if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
		dragInput = input
		mousePos = UIS:GetMouseLocation()
		framePos = Frame.Position
		safeConnect(input.Changed, function()
			if dragInput and dragInput.UserInputState == Enum.UserInputState.End then
				dragInput = nil
			end
		end)
	end
end)

safeConnect(RunService.Heartbeat, function()
	if dragInput and GUI.Enabled then
		local delta = UIS:GetMouseLocation() - mousePos
		Frame.Position = UDim2.new(framePos.X.Scale, framePos.X.Offset + delta.X, framePos.Y.Scale, framePos.Y.Offset + delta.Y)
	end
end)

safeConnect(RunService.Heartbeat, checkCurrentModelStatus)

applyTheme()
updateSpeedLabel()
refreshHorseList()
GUI.Enabled = true
